<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Crumbl Crafts ¬∑ Live Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üç™</text></svg>" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            color-scheme: dark;
            --bg-primary: #0a0f1a;
            --bg-secondary: #1a2030;
            --bg-tertiary: #2a3040;
            --panel: rgba(30, 40, 60, 0.5);
            --panel-hover: rgba(40, 50, 70, 0.7);
            --card: rgba(40, 50, 70, 0.4);
            --card-hover: rgba(50, 60, 80, 0.6);
            --primary: #ff1744;
            --primary-glow: rgba(255, 23, 68, 0.6);
            --secondary: #2979ff;
            --accent: #ffd700;
            --success: #00e676;
            --warning: #ff9100;
            --danger: #ff1744;
            --text: #ffffff;
            --text-bright: #ffffff;
            --text-muted: #b0b8d0;
            --border: rgba(255, 255, 255, 0.15);
            --glow: rgba(255, 23, 68, 0.3);
        }
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        html { 
            scroll-behavior: smooth; 
        }
        body {
            font-family: 'Fredoka', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            position: relative;
            /* Performance optimizations */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        /* Screen reader only class for accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url('happy.gif');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.5;
            pointer-events: none;
            z-index: 0;
            mix-blend-mode: screen;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 215, 0, 0.02) 2px, rgba(255, 215, 0, 0.02) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 212, 255, 0.02) 2px, rgba(0, 212, 255, 0.02) 4px);
            pointer-events: none;
            z-index: 0;
            opacity: 0.3;
        }
        .wrapper { 
            position: relative; 
            z-index: 1; 
            max-width: 100%; 
            margin: 0 auto; 
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 520px;
            gap: 16px;
            min-height: calc(100vh - 60px);
        }
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .glass {
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.05) 0.8px, transparent 0.8px),
                rgba(30, 40, 60, 0.6);
            background-size: 8px 8px, 8px 8px, 4px 4px, 100% 100%;
            background-position: 0 0, 4px 4px, 2px 2px, 0 0;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 12px 40px rgba(255, 23, 68, 0.25), 
                        0 0 0 1px rgba(255, 255, 255, 0.1),
                        inset 0 2px 0 rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px) saturate(1.2);
            -webkit-backdrop-filter: blur(20px) saturate(1.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            contain: layout style paint;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        .glass::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: linear-gradient(90deg, 
                #ff1744 0%, 
                #ffffff 25%, 
                #2979ff 50%, 
                #ffffff 75%, 
                #ff1744 100%);
            background-size: 200% 100%;
            opacity: 0.9;
            box-shadow: 0 0 15px rgba(255, 23, 68, 0.4),
                        0 2px 0 rgba(255, 255, 255, 0.3),
                        0 -2px 0 rgba(0, 0, 0, 0.3);
        }
        .glass::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.4) 50%, 
                transparent 70%);
            transform: translate(-100%, -100%) rotate(45deg);
            opacity: 0;
            pointer-events: none;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass:hover::after {
            transform: translate(100%, 100%) rotate(45deg);
            opacity: 0;
        }
        .glass:hover {
            border-color: rgba(255, 23, 68, 0.5);
            box-shadow: 0 16px 48px rgba(255, 23, 68, 0.35), 
                        0 0 0 2px rgba(255, 255, 255, 0.2),
                        inset 0 3px 0 rgba(255, 255, 255, 0.2);
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                rgba(35, 45, 65, 0.7);
            background-size: 8px 8px, 8px 8px, 100% 100%;
            transform: translateY(-2px);
        }
        header.hero { 
            border-radius: 20px !important;
            border-width: 3px !important;
            box-shadow: 0 20px 60px rgba(255, 23, 68, 0.35),
                        0 0 0 1px rgba(255, 255, 255, 0.15),
                        inset 0 2px 0 rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(20px) saturate(1.3) !important;
        }
        .logo-container { 
            display: flex; 
            align-items: center; 
            gap: 16px;
        }
        .logo-icon {
            width: 50px !important; 
            height: 50px !important;
            background: linear-gradient(135deg, rgba(255, 23, 68, 0.2), rgba(41, 121, 255, 0.2)) !important;
            border-radius: 10px !important;
            display: flex !important; 
            align-items: center !important;
            justify-content: center !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px rgba(255, 23, 68, 0.35),
                        0 0 0 1px rgba(255, 255, 255, 0.1),
                        inset 0 2px 0 rgba(255, 255, 255, 0.3) !important;
            position: relative;
            transition: transform 0.3s ease;
        }
        .logo-icon:hover {
            transform: translateY(-4px);
        }
        .logo-icon img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }
        .logo-text h1 {
            font-size: 2rem !important;
            font-weight: 900 !important;
            background: linear-gradient(135deg, #ffffff, #e0e8ff) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            letter-spacing: -0.5px !important;
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8)) 
                    drop-shadow(0 0 12px rgba(255, 23, 68, 0.4)) !important;
            text-rendering: optimizeLegibility;
        }
        .logo-text .tagline { 
            color: #c0c8e0 !important; 
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            margin-top: 2px;
        }
        .status-badge {
            display: flex !important; 
            align-items: center !important; 
            gap: 8px !important;
            padding: 8px 16px !important; 
            border-radius: 10px !important;
            background: rgba(0, 230, 118, 0.15) !important;
            border: 2px solid rgba(0, 230, 118, 0.5) !important;
            font-size: 0.75rem !important; 
            font-weight: 800 !important; 
            letter-spacing: 1.5px !important;
            color: var(--success) !important;
            box-shadow: 0 4px 20px rgba(0, 230, 118, 0.3),
                        0 0 0 1px rgba(255, 255, 255, 0.1),
                        inset 0 2px 0 rgba(255, 255, 255, 0.2) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8),
                         0 0 12px rgba(0, 230, 118, 0.5) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.2); }
            50% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.4); }
        }
        .status-dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: var(--success); 
            box-shadow: 0 0 8px currentColor;
        }
        @keyframes blink { 
            0%, 100% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.6; transform: scale(0.85); } 
        }
        .status-dot.offline {
            background: var(--danger);
            animation: none;
        }
        .status-dot.syncing {
            animation: rotate 1s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .stats-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px;
        }
        .stat-card {
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.05) 0.8px, transparent 0.8px),
                rgba(30, 40, 60, 0.6);
            background-size: 8px 8px, 8px 8px, 4px 4px, 100% 100%;
            background-position: 0 0, 4px 4px, 2px 2px, 0 0;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            position: relative; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            backdrop-filter: blur(20px) saturate(1.2);
            -webkit-backdrop-filter: blur(20px) saturate(1.2);
            box-shadow: 0 12px 40px rgba(255, 23, 68, 0.25), 
                        0 0 0 1px rgba(255, 255, 255, 0.1),
                        inset 0 2px 0 rgba(255, 255, 255, 0.15);
            animation: cardFloat 6s ease-in-out infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes cardFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-4px); }
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                #ff1744 0%, 
                #ffffff 25%, 
                #2979FF 50%, 
                #ffffff 75%, 
                #ff1744 100%);
            background-size: 200% 100%;
            opacity: 0;
            transition: opacity 0.4s ease;
            border-radius: 12px 12px 0 0;
            z-index: 1;
        }
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.15), 
                transparent);
            animation: shine 3s infinite;
        }
        @keyframes shine {
            0% { left: -100%; }
            50%, 100% { left: 200%; }
        }
        .stat-card:hover { 
            transform: translateY(-8px) scale(1.02);
            animation: none;
            border-color: rgba(255, 23, 68, 0.4);
            box-shadow: 0 16px 48px rgba(255, 23, 68, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.2),
                        inset 0 2px 0 rgba(255, 255, 255, 0.2),
                        0 0 60px rgba(255, 23, 68, 0.3);
        }
        .stat-card:hover::before {
            opacity: 1;
            animation: shimmer 2s linear infinite;
        }
        @keyframes shimmer {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .stat-card .icon-wrapper { 
            width: 56px; 
            height: 56px; 
            border-radius: 10px; 
            display: grid; 
            place-items: center; 
            font-size: 26px; 
            flex-shrink: 0;
            background: rgba(255, 23, 68, 0.15);
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
            animation: iconPulse 3s ease-in-out infinite;
            border: 1px solid rgba(255, 23, 68, 0.3);
        }
        @keyframes iconPulse {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), 
                            inset 0 1px 0 rgba(255, 255, 255, 0.15),
                            0 0 20px rgba(255, 23, 68, 0.3); 
            }
            50% { 
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), 
                            inset 0 1px 0 rgba(255, 255, 255, 0.15),
                            0 0 35px rgba(255, 23, 68, 0.5); 
            }
        }
        .stat-card:hover .icon-wrapper {
            transform: scale(1.1) rotate(5deg);
            animation: none;
            background: rgba(255, 23, 68, 0.25);
            border-color: rgba(255, 23, 68, 0.5);
            box-shadow: 0 8px 24px rgba(255, 23, 68, 0.4), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        0 0 40px rgba(255, 23, 68, 0.4);
        }
        .stat-card .icon-wrapper i {
            position: relative;
            z-index: 1;
        }
        .stat-card .stat-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }
        .stat-card .stat-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .stat-card .label { 
            color: var(--text-muted); 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            letter-spacing: 0.15em; 
            font-weight: 700;
            line-height: 1;
            opacity: 0.9;
        }
        .stat-card .value { 
            display: block; 
            font-size: 2.5rem; 
            font-weight: 800; 
            background: linear-gradient(135deg, 
                #ff1744 0%, 
                #ff6b9d 25%,
                #c471ed 50%,
                #4facfe 75%,
                #00f2fe 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientFlow 4s ease infinite;
            letter-spacing: -0.03em;
            line-height: 1;
            filter: drop-shadow(0 2px 8px rgba(255, 23, 68, 0.6));
        }
        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .stat-card:hover .value {
            filter: drop-shadow(0 4px 16px rgba(255, 23, 68, 0.8)) drop-shadow(0 0 24px rgba(41, 121, 255, 0.6));
        }
        @keyframes rainbowShift {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        @keyframes ctaPulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 8px 24px rgba(255, 23, 68, 0.6), 
                            0 0 40px rgba(255, 23, 68, 0.4), 
                            inset 0 2px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1.05);
                box-shadow: 0 12px 32px rgba(255, 23, 68, 0.8), 
                            0 0 60px rgba(255, 23, 68, 0.6), 
                            inset 0 3px 0 rgba(255, 255, 255, 0.4);
            }
        }
        @keyframes fadeInButton {
            0% { 
                opacity: 0;
                transform: scale(0.8);
            }
            100% { 
                opacity: 1;
                transform: scale(1);
            }
        }
        .stat-card .trend { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            margin-top: 8px; 
            font-size: 0.65rem; 
            font-weight: 600; 
            padding: 3px 8px; 
            border-radius: 50px; 
            background: rgba(16, 185, 129, 0.15); 
            color: var(--success); 
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .count-up { 
            animation: countFade 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        @keyframes countFade { 
            0% { 
                opacity: 0; 
                transform: translateY(10px) scale(0.95); 
            }
            50% {
                opacity: 1;
                transform: translateY(-2px) scale(1.05);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
        }
        .sidebar-panel {
            position: sticky;
            top: 24px;
            height: calc(100vh - 48px);
            display: flex;
            flex-direction: column;
            overflow: visible;
            contain: layout style;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-bright);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.8),
                         -1px -1px 0 rgba(255, 23, 68, 0.3),
                         0 0 20px rgba(255, 23, 68, 0.4);
            letter-spacing: 0.02em;
        }
        .section-subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 20px;
        }
        .builders-grid { 
            display: flex;
            flex-direction: column;
            gap: 12px; 
        }
        .podium-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .podium-card {
            background: 
                radial-gradient(circle at 30% 40%, rgba(255, 215, 0, 0.2) 2px, transparent 2px),
                radial-gradient(circle at 70% 60%, rgba(255, 215, 0, 0.2) 2px, transparent 2px),
                radial-gradient(circle at 50% 80%, rgba(255, 255, 255, 0.1) 1.5px, transparent 1.5px),
                radial-gradient(circle at 20% 70%, rgba(255, 255, 255, 0.1) 1.5px, transparent 1.5px),
                linear-gradient(135deg, 
                    rgba(255, 215, 0, 0.25) 0%, 
                    rgba(40, 50, 70, 0.8) 50%,
                    rgba(255, 237, 78, 0.2) 100%);
            background-size: 12px 12px, 12px 12px, 6px 6px, 8px 8px, 100% 100%;
            background-position: 0 0, 6px 6px, 3px 3px, 4px 7px, 0 0;
            border: 3px solid rgba(255, 215, 0, 0.5);
            border-radius: 16px;
            padding: 16px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 160px;
            backdrop-filter: blur(18px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6),
                        0 0 0 4px rgba(255, 215, 0, 0.25),
                        inset 0 2px 0 rgba(255, 255, 255, 0.15),
                        inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            transform: perspective(1000px) rotateX(0deg);
        }
        .podium-card.rank-1 {
            order: 2;
            padding-top: 20px;
        }
        .podium-card.rank-1::after {
            content: '‚≠ê';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            transition: transform 0.3s ease;
        }
        .podium-card.rank-1:hover::after {
            transform: translateX(-50%) scale(1.1);
        }
        .podium-card.rank-1::before {
            content: 'CHAMPION';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 16px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1f35;
            font-weight: 900;
            font-size: 10px;
            letter-spacing: 2px;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(255, 215, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        .podium-card.rank-2 {
            order: 1;
        }
        .podium-card.rank-3 {
            order: 3;
        }
        .builder-card {
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.12) 1.5px, transparent 1.5px),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.12) 1.5px, transparent 1.5px),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                linear-gradient(145deg, 
                    rgba(255, 23, 68, 0.2) 0%,
                    rgba(40, 50, 70, 0.7) 30%,
                    rgba(41, 121, 255, 0.2) 100%);
            background-size: 10px 10px, 10px 10px, 5px 5px, 100% 100%;
            background-position: 0 0, 5px 5px, 2px 2px, 0 0;
            border: 2px solid rgba(255, 23, 68, 0.4);
            border-radius: 12px;
            padding: 10px 14px;
            position: relative;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                        border-color 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            will-change: transform;
            contain: layout style;
            transform: translateZ(0);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5),
                        0 0 0 3px rgba(255, 23, 68, 0.2),
                        inset 0 2px 0 rgba(255, 255, 255, 0.12),
                        inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            transform: perspective(1000px) rotateX(0deg);
        }

        .builder-card:hover, .podium-card:hover { 
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.7), 
                        0 0 0 6px rgba(255, 23, 68, 0.6),
                        inset 0 2px 0 rgba(255, 255, 255, 0.25); 
            border-color: rgba(255, 23, 68, 0.8);
            filter: brightness(1.15);
        }

        .podium-card.rank-1 .rank-badge { background: linear-gradient(135deg, #ffd700, #ffa500); color: #000; }
        .podium-card.rank-2 .rank-badge { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .podium-card.rank-3 .rank-badge { background: linear-gradient(135deg, #cd7f32, #8b4513); color: #fff; }
        .rank-badge { 
            position: absolute; 
            top: -6px; 
            left: -6px; 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            display: grid; 
            place-items: center; 
            font-weight: 800; 
            font-size: 0.75rem; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); 
            z-index: 2;
        }
        .rank-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: var(--glow);
            color: var(--primary);
            font-weight: 700;
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        .builder-avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 10px; 
            background: var(--glow); 
            border: 2px solid var(--border); 
            display: grid; 
            place-items: center; 
            font-size: 20px; 
            overflow: hidden; 
            transition: transform 0.3s ease; 
            flex-shrink: 0;
        }
        .podium-card .builder-avatar {
            width: 60px;
            height: 60px;
            font-size: 24px;
            border-radius: 12px;
        }
        .builder-card:hover .builder-avatar, .podium-card:hover .builder-avatar { 
            transform: scale(1.05); 
            border-color: var(--primary);
        }
        .builder-avatar img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .builder-info {
            flex: 1;
            min-width: 0;
        }
        .podium-card .builder-info {
            text-align: center;
            width: 100%;
        }
        .builder-name { 
            font-size: 0.85rem; 
            font-weight: 800; 
            color: var(--text-bright); 
            margin-bottom: 6px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.7),
                         -1px -1px 0 rgba(255, 255, 255, 0.1);
        }
        .podium-card .builder-name {
            font-size: 0.95rem;
            margin-bottom: 8px;
            font-weight: 900;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.8),
                         -1px -1px 0 rgba(255, 215, 0, 0.3),
                         0 0 20px rgba(255, 215, 0, 0.4);
        }
        .builder-meta { 
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.7rem; 
            color: var(--text-muted); 
        }
        .podium-card .builder-meta {
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }
        .builder-meta .stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .podium-card .builder-meta .stat {
            justify-content: center;
            width: 100%;
        }
        .builder-meta .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        .builder-meta .stat-value {
            font-weight: 700;
            color: var(--text-bright);
            font-size: 0.85rem;
        }
        .builder-meta .rating .stat-value { 
            color: var(--warning); 
        }
        .activity-feed-container { 
            flex: 0 0 40%;
            display: flex; 
            flex-direction: column;
            min-height: 0;
            max-height: 40%;
            overflow: visible;
            position: relative;
            margin-bottom: 16px;
        }
        .feed-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }
        .feed-header .section-title {
            font-size: 1.1rem;
            margin-bottom: 0;
            font-weight: 800;
        }
        .feed-header .section-subtitle {
            font-size: 0.85rem;
            margin-top: 2px;
        }
        .feed-stats {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .feed-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--glow);
            border-radius: 50px;
        }
        .feed-stat .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary);
            box-shadow: 0 0 8px var(--primary-glow);
        }
        .activity-list { 
            overflow-y: scroll !important; 
            overflow-x: hidden;
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            padding-right: 12px;
            height: 100%;
            flex: 1;
            min-height: 150px;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-gutter: stable;
            will-change: scroll-position;
            scroll-padding: 8px;
        }
        .activity-list::-webkit-scrollbar { 
            width: 12px; 
        }
        .activity-list::-webkit-scrollbar-track { 
            background: linear-gradient(180deg, rgba(20, 30, 50, 0.8), rgba(10, 20, 40, 0.9)); 
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.08);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            margin: 4px 0;
        }
        .activity-list::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, rgba(255, 23, 68, 0.8), rgba(255, 23, 68, 0.5)); 
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(0, 0, 0, 0.5);
            box-shadow: 0 2px 8px rgba(255, 23, 68, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .activity-list::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, rgba(255, 23, 68, 1), rgba(255, 23, 68, 0.8)); 
            box-shadow: 0 0 16px rgba(255, 23, 68, 1), 0 4px 12px rgba(255, 23, 68, 0.6), inset 0 2px 0 rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scaleX(1.1);
        }
        .activity-list::-webkit-scrollbar-thumb:active { 
            background: linear-gradient(180deg, rgba(255, 52, 82, 1), rgba(255, 23, 68, 0.9)); 
            box-shadow: 0 0 20px rgba(255, 23, 68, 1), inset 0 2px 0 rgba(255, 255, 255, 0.4);
        }

        /* Chat System Styles */
        .chat-container {
            flex: 0 0 60%;
            display: flex;
            flex-direction: column;
            min-height: 0;
            max-height: 60%;
            overflow: visible;
            position: relative;
            background: linear-gradient(135deg, rgba(41, 121, 255, 0.12), rgba(124, 58, 237, 0.08));
            border: 2px solid rgba(41, 121, 255, 0.4);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 0 40px rgba(41, 121, 255, 0.3), 
                        0 0 80px rgba(41, 121, 255, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
        }
        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px 12px;
            border-bottom: 3px solid rgba(41, 121, 255, 0.4);
            flex-shrink: 0;
            background: linear-gradient(90deg, rgba(41, 121, 255, 0.15), rgba(124, 58, 237, 0.1));
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(41, 121, 255, 0.2);
        }
        .chat-header .section-title {
            font-size: 1.15rem;
            margin-bottom: 0;
            font-weight: 900;
            color: #2979FF;
            text-shadow: 0 0 20px rgba(41, 121, 255, 0.6),
                         0 2px 4px rgba(0, 0, 0, 0.5);
            filter: drop-shadow(0 0 10px rgba(41, 121, 255, 0.8));
        }
        .chat-header .section-subtitle {
            font-size: 0.75rem;
            margin-top: 0;
            opacity: 0.8;
        }
        .chat-channels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .chat-channel-btn {
            padding: 4px 10px;
            background: rgba(40, 50, 70, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chat-channel-btn:hover {
            background: rgba(60, 70, 90, 0.7);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .chat-channel-btn.active {
            background: linear-gradient(135deg, rgba(41, 121, 255, 0.6), rgba(41, 121, 255, 0.4));
            border-color: rgba(41, 121, 255, 0.8);
            color: white;
            box-shadow: 0 0 12px rgba(41, 121, 255, 0.4);
        }
        .chat-messages {
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 12px;
            height: 100%;
            flex: 1;
            min-height: 150px;
            max-height: 100%;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-gutter: stable;
            will-change: scroll-position;
            scroll-padding: 8px;
            margin-bottom: 12px;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .chat-messages::-webkit-scrollbar {
            width: 12px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: linear-gradient(180deg, rgba(20, 30, 50, 0.8), rgba(10, 20, 40, 0.9));
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.08);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            margin: 4px 0;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(41, 121, 255, 0.8), rgba(41, 121, 255, 0.5));
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(0, 0, 0, 0.5);
            box-shadow: 0 2px 8px rgba(41, 121, 255, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(41, 121, 255, 1), rgba(41, 121, 255, 0.8));
            box-shadow: 0 0 16px rgba(41, 121, 255, 1), 0 4px 12px rgba(41, 121, 255, 0.6), inset 0 2px 0 rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scaleX(1.1);
        }
        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 4px 8px;
            background: transparent;
            border-radius: 6px;
            border: none;
            transition: all 0.15s ease;
            position: relative;
            margin-bottom: 1px;
        }
        .chat-message:hover {
            background: rgba(41, 121, 255, 0.06);
            border-left: 2px solid rgba(41, 121, 255, 0.5);
            padding-left: 6px;
        }
        .chat-message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: linear-gradient(135deg, #2979FF 0%, #7C3AED 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 800;
            font-size: 0.8rem;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.15s ease;
        }
        .chat-message:hover .chat-message-avatar {
            transform: scale(1.05);
        }
        .chat-message-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .chat-message-author {
            font-weight: 800;
            background: linear-gradient(135deg, #FF1744 0%, #FF5252 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 0.9rem;
            flex-shrink: 0;
            filter: drop-shadow(0 1px 2px rgba(255, 23, 68, 0.3));
            letter-spacing: 0.2px;
        }
        .chat-message-text {
            color: var(--text);
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-word;
            margin-top: 1px;
        }
        .loading-indicator {
            padding: 12px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            font-style: italic;
            background: linear-gradient(135deg, rgba(30, 50, 80, 0.3), rgba(20, 40, 70, 0.3));
            border-radius: 8px;
            margin: 8px 0;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .chat-message-header {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .chat-message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            flex-shrink: 0;
            opacity: 0.7;
            font-weight: 500;
        }
        .chat-message.reply {
            margin-left: 24px;
            border-left: 2px solid #2979FF;
            padding-left: 8px;
            background: rgba(41, 121, 255, 0.05);
        }
        .chat-message-reply-info {
            font-size: 0.75rem;
            color: #2979FF;
            font-style: italic;
            margin-bottom: 2px;
            font-weight: 600;
            background: rgba(41, 121, 255, 0.1);
            padding: 3px 6px;
            border-radius: 4px;
            border-left: 2px solid #2979FF;
        }
        .chat-mention {
            color: #FF5252;
            font-weight: 900;
            background: rgba(255, 23, 68, 0.25);
            padding: 2px 8px;
            border-radius: 6px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 23, 68, 0.4);
            box-shadow: 0 0 12px rgba(255, 23, 68, 0.3);
            animation: mentionGlow 2s ease-in-out infinite;
        }
        @keyframes mentionGlow {
            0%, 100% { box-shadow: 0 0 12px rgba(255, 23, 68, 0.3); }
            50% { box-shadow: 0 0 20px rgba(255, 23, 68, 0.5); }
        }
        .chat-input-container {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(40, 50, 70, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.9rem;
            font-family: 'Fredoka', sans-serif;
            transition: all 0.2s ease;
            outline: none;
            backdrop-filter: blur(4px);
        }
        .chat-input:focus {
            background: linear-gradient(135deg, rgba(50, 60, 80, 0.8), rgba(40, 50, 70, 0.8));
            border-color: #FF1744;
            box-shadow: 0 0 0 3px rgba(255, 23, 68, 0.3), inset 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }
        .chat-input::placeholder {
            color: var(--text-muted);
        }
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #FF1744 0%, #FF5252 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(255, 23, 68, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        .chat-send-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255, 255, 255, 0.2) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .chat-send-btn:hover::before {
            opacity: 1;
        }
        .chat-send-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 24px rgba(255, 23, 68, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        .chat-send-btn:active {
            transform: scale(0.95);
        }

        /* Advanced Chat Features */
        .chat-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
            flex-wrap: wrap;
            padding: 0 2px;
        }
        .chat-action-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(40, 50, 70, 0.6), rgba(30, 40, 60, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .chat-action-btn:hover {
            background: linear-gradient(135deg, rgba(60, 80, 100, 0.7), rgba(50, 60, 80, 0.7));
            border-color: rgba(41, 121, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(41, 121, 255, 0.3);
        }
        .chat-action-btn.active {
            background: linear-gradient(135deg, rgba(41, 121, 255, 0.5), rgba(124, 58, 237, 0.5));
            border-color: rgba(41, 121, 255, 0.8);
            box-shadow: 0 0 16px rgba(41, 121, 255, 0.4);
        }
        .emoji-picker, .gif-picker {
            position: absolute;
            bottom: 85px;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(20, 30, 50, 0.98), rgba(30, 40, 60, 0.98));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
            max-height: 280px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            backdrop-filter: blur(16px);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(41, 121, 255, 0.2);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .emoji-picker.show, .gif-picker.show {
            display: block;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }
        .emoji-item {
            font-size: 1.6rem;
            cursor: pointer;
            padding: 6px;
            text-align: center;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .emoji-item:hover {
            background: linear-gradient(135deg, rgba(41, 121, 255, 0.4), rgba(124, 58, 237, 0.4));
            transform: scale(1.25) rotate(-5deg);
            box-shadow: 0 4px 12px rgba(41, 121, 255, 0.4);
        }
        .gif-search {
            width: 100%;
            padding: 8px 12px;
            background: rgba(40, 50, 70, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 10px;
            outline: none;
        }
        .gif-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        .gif-item {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .gif-item:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(41, 121, 255, 0.5);
        }
        .gif-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        .chat-message-text img {
            max-width: 250px;
            max-height: 250px;
            border-radius: 8px;
            margin-top: 4px;
            display: block;
        }
        .chat-message-text img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 4px;
            display: block;
        }
        .reply-preview {
            padding: 8px 12px;
            background: linear-gradient(90deg, rgba(41, 121, 255, 0.2), rgba(41, 121, 255, 0.1));
            border-left: 4px solid #2979FF;
            border-radius: 8px;
            margin-bottom: 8px;
            display: none;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(41, 121, 255, 0.2);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .reply-preview.show {
            display: flex;
        }
        .reply-preview-text {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .reply-preview-close {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        .reply-preview-close:hover {
            color: var(--primary);
        }
        .message-actions {
            display: none;
            gap: 4px;
            margin-left: 8px;
        }
        .chat-message:hover .message-actions {
            display: flex;
        }
        .message-action-btn {
            padding: 2px 6px;
            background: rgba(41, 121, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }
        .message-action-btn:hover {
            background: rgba(41, 121, 255, 0.5);
        }
        .new-messages-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
            font-size: 0.75rem;
            font-weight: 800;
            color: #FF1744;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            animation: dividerPulse 2s ease-in-out infinite;
        }
        @keyframes dividerPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }
        .new-messages-divider::before,
        .new-messages-divider::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, #FF1744, transparent);
            box-shadow: 0 0 8px rgba(255, 23, 68, 0.6);
        }
        .new-messages-counter {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #FF1744 0%, #FF5252 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 900;
            box-shadow: 0 4px 16px rgba(255, 23, 68, 0.6),
                        0 0 30px rgba(255, 23, 68, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            animation: counterBounce 1s ease-in-out infinite;
            border: 2px solid rgba(255, 255, 255, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        @keyframes counterBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-6px) scale(1.05); }
        }
        .new-messages-counter:hover {
            transform: scale(1.15) translateY(-2px) !important;
            box-shadow: 0 6px 24px rgba(255, 23, 68, 0.8),
                        0 0 40px rgba(255, 23, 68, 0.6);
            animation: none;
        }
        .new-messages-counter::before {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            box-shadow: 0 0 12px #00ff00;
            animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        .new-messages-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
            font-size: 0.75rem;
            font-weight: 800;
            color: #FF1744;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .new-messages-divider::before,
        .new-messages-divider::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, #FF1744, transparent);
        }
        .new-messages-counter {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #FF1744, #FF5252);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 800;
            box-shadow: 0 2px 8px rgba(255, 23, 68, 0.4);
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
            animation: bounce 2s ease-in-out infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .new-messages-counter:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(255, 23, 68, 0.6);
        }
        .mention-autocomplete {
            position: absolute;
            bottom: 85px;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(20, 30, 50, 0.98), rgba(30, 40, 60, 0.98));
            border: 2px solid rgba(255, 23, 68, 0.4);
            border-radius: 12px;
            padding: 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            backdrop-filter: blur(16px);
            box-shadow: 0 -4px 24px rgba(255, 23, 68, 0.3);
        }
        .mention-autocomplete.show {
            display: block;
        }
        .mention-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            color: var(--text);
            font-weight: 700;
        }
        .mention-item:hover,
        .mention-item.selected {
            background: linear-gradient(135deg, rgba(255, 23, 68, 0.3), rgba(255, 82, 82, 0.3));
            transform: translateX(4px);
        }

        /* Build Museum Styles */
        .build-museum-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .build-card {
            background: linear-gradient(135deg, rgba(40, 50, 70, 0.6), rgba(30, 40, 60, 0.6));
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }
        .build-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 23, 68, 0.5);
            box-shadow: 0 12px 32px rgba(255, 23, 68, 0.3);
        }
        .build-card-media {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        .build-card-media img,
        .build-card-media video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .build-card:hover .build-card-media img,
        .build-card:hover .build-card-media video {
            transform: scale(1.05);
        }
        .build-card-type {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            backdrop-filter: blur(8px);
        }
        .build-card-content {
            padding: 12px;
        }
        .build-card-title {
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--text-bright);
            margin-bottom: 6px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        .build-card-author {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .build-card-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .build-card-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #FFD700;
        }
        .build-card-actions {
            display: flex;
            gap: 8px;
        }
        .build-action-btn {
            background: rgba(41, 121, 255, 0.2);
            border: 1px solid rgba(41, 121, 255, 0.4);
            color: #2979FF;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .build-action-btn:hover {
            background: rgba(41, 121, 255, 0.4);
            transform: scale(1.05);
        }
        .build-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }
        .build-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .build-modal-content {
            background: linear-gradient(135deg, rgba(30, 40, 60, 0.98), rgba(20, 30, 50, 0.98));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }
        .build-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 23, 68, 0.8);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        .build-modal-close:hover {
            background: #FF1744;
            transform: rotate(90deg);
        }
        .build-modal-media {
            width: 100%;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.5);
        }
        .build-modal-media img,
        .build-modal-media video {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
        }
        .build-modal-body {
            padding: 24px;
        }
        .build-modal-title {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--text-bright);
            margin-bottom: 12px;
        }
        .build-modal-description {
            color: var(--text);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .build-comments {
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            margin-top: 20px;
        }
        .build-comment-input {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .build-comment-input input {
            flex: 1;
            background: rgba(40, 50, 70, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
        }
        .build-comment-input button {
            background: linear-gradient(135deg, #2979FF, #7C3AED);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .build-comment-input button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(41, 121, 255, 0.4);
        }
        .build-comment {
            background: rgba(40, 50, 70, 0.4);
            border-left: 3px solid #2979FF;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .build-comment-author {
            font-weight: 700;
            color: #2979FF;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .build-comment-text {
            color: var(--text);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        #uploadBuildBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 23, 68, 0.6);
        }

        .activity-item { 
            display: flex; 
            align-items: flex-start; 
            gap: 10px; 
            padding: 10px; 
            background: 
                radial-gradient(circle at 90% 50%, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                radial-gradient(circle at 10% 50%, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.05) 0.5px, transparent 0.5px),
                rgba(40, 50, 70, 0.4);
            background-size: 6px 6px, 6px 6px, 3px 3px, 100% 100%;
            background-position: 0 0, 3px 3px, 1px 1px, 0 0;
            border-radius: 14px; 
            border: 2px solid rgba(255, 255, 255, 0.1); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
            overflow: visible;
            backdrop-filter: blur(12px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            min-height: fit-content;
        }
        .activity-item::before {
            content: '';
            position: absolute;
            left: -2px;
            top: -2px;
            height: calc(100% + 4px);
            width: 5px;
            background: linear-gradient(180deg, 
                #FF1744 0%, 
                #2979FF 25%,
                #7C3AED 50%,
                #2979FF 75%,
                #FF1744 100%);
            background-size: 100% 200%;
            border-radius: 14px 0 0 14px;
            opacity: 0;
            transition: opacity 0.3s ease, background-position 0.5s ease;
            animation: rainbowSlide 3s linear infinite;
        }
        @keyframes rainbowSlide {
            0% { background-position: 0% 0%; }
            100% { background-position: 0% 200%; }
        }
        .activity-item:hover::before {
            opacity: 1;
        }
        .activity-item:hover { 
            background: 
                repeating-linear-gradient(90deg, transparent 0px, rgba(255, 255, 255, 0.05) 1px, transparent 2px, transparent 6px),
                radial-gradient(circle at 90% 50%, rgba(255, 255, 255, 0.12) 1.5px, transparent 1.5px),
                radial-gradient(circle at 10% 50%, rgba(255, 255, 255, 0.12) 1.5px, transparent 1.5px),
                rgba(50, 60, 80, 0.6);
            background-size: 20px 100%, 6px 6px, 6px 6px, 100% 100%;
            border-color: rgba(255, 23, 68, 0.6);
            transform: translateX(4px) scale(1.02);
            box-shadow: 0 8px 32px rgba(255, 23, 68, 0.4),
                        0 0 40px rgba(41, 121, 255, 0.3);
        }
        .activity-icon { 
            width: 36px; 
            height: 36px; 
            border-radius: 8px; 
            display: grid; 
            place-items: center; 
            font-size: 18px; 
            flex-shrink: 0;
            position: relative;
        }
        .activity-icon::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 10px;
            background: inherit;
            filter: blur(8px);
            opacity: 0.4;
            z-index: -1;
        }
        .activity-icon.type-sent { background: rgba(0, 212, 255, 0.15); color: var(--primary); }
        .activity-icon.type-accepted { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .activity-icon.type-rejected { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .activity-icon.type-completed { background: rgba(124, 58, 237, 0.15); color: var(--secondary); }
        .activity-icon.type-rating { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .activity-icon.type-new_request_thread { background: rgba(255, 107, 53, 0.15); color: var(--accent); }
        .activity-icon.type-task_claimed { background: rgba(124, 58, 237, 0.15); color: #7c3aed; }
        .activity-icon.type-member_join { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .activity-icon.type-member_leave { background: rgba(148, 163, 184, 0.15); color: var(--text-muted); }
        .activity-content { 
            flex: 1; 
            min-width: 0; 
            overflow: visible;
        }
        .activity-message { 
            font-size: 0.875rem; 
            color: var(--text); 
            line-height: 1.6; 
            margin-bottom: 6px;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            overflow-wrap: break-word;
        }
        .activity-message a { 
            color: var(--primary); 
            text-decoration: none; 
            font-weight: 600;
            transition: color 0.2s ease;
        }
        .activity-message a:hover { 
            color: var(--text-bright);
            text-decoration: underline;
        }
        .activity-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .activity-time {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-muted);
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.6);
        }
        .activity-type-badge {
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        .content-grid { 
            display: grid; 
            gap: 24px; 
        }
        .pipeline-list { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        .pipeline-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px; 
            background: rgba(255, 255, 255, 0.02); 
            border-radius: 12px; 
            border: 1px solid transparent; 
            transition: all 0.3s ease; 
        }
        .pipeline-item:hover { 
            background: rgba(255, 255, 255, 0.04); 
            border-color: var(--border); 
        }
        .pipeline-info {
            flex: 1;
        }
        .pipeline-label { 
            font-weight: 600; 
            color: var(--text); 
            margin-bottom: 4px;
        }
        .pipeline-trend { 
            font-size: 0.75rem; 
            color: var(--text-muted); 
        }
        .pipeline-value { 
            font-size: 1.5rem; 
            font-weight: 800; 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .progress-bar { 
            width: 100%; 
            height: 6px; 
            border-radius: 50px; 
            background: rgba(255, 255, 255, 0.05); 
            overflow: hidden; 
            margin-top: 10px; 
        }
        .progress-fill { 
            height: 100%; 
            border-radius: inherit; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            transform-origin: left; 
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
        }
        .progress-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }
        .insights-list { 
            display: grid; 
            gap: 12px; 
        }
        .insight-card { 
            padding: 16px; 
            background: rgba(255, 255, 255, 0.02); 
            border-radius: 12px; 
            border: 1px solid transparent; 
            transition: all 0.3s ease; 
        }
        .insight-card:hover { 
            background: rgba(255, 255, 255, 0.04); 
            border-color: var(--border); 
        }
        .insight-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .insight-title { 
            font-weight: 600; 
            color: var(--text); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .insight-detail { 
            font-size: 0.85rem; 
            color: var(--text-muted); 
            margin-bottom: 10px; 
        }
        .insight-badge { 
            display: inline-flex; 
            padding: 4px 12px; 
            border-radius: 50px; 
            font-size: 0.75rem; 
            font-weight: 700; 
            border: 1px solid; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .insight-badge.good { 
            background: rgba(16, 185, 129, 0.1); 
            border-color: rgba(16, 185, 129, 0.3); 
            color: var(--success); 
        }
        .insight-badge.warning { 
            background: rgba(245, 158, 11, 0.1); 
            border-color: rgba(245, 158, 11, 0.3); 
            color: var(--warning); 
        }
        .insight-badge.critical { 
            background: rgba(239, 68, 68, 0.1); 
            border-color: rgba(239, 68, 68, 0.3); 
            color: var(--danger); 
        }
        .news-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .news-card {
            display: flex;
            gap: 16px;
            padding: 12px;
            background: 
                radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 45% 50%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 75% 50%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 30% 70%, rgba(255, 255, 255, 0.08) 1.5px, transparent 1.5px),
                linear-gradient(90deg, 
                    rgba(255, 23, 68, 0.25) 0%,
                    rgba(40, 50, 70, 0.7) 20%,
                    rgba(40, 50, 70, 0.7) 80%,
                    rgba(41, 121, 255, 0.25) 100%);
            background-size: 5px 5px, 5px 5px, 5px 5px, 7px 7px, 100% 100%;
            background-position: 0 0, 2px 2px, 4px 4px, 3px 5px, 0 0;
            border-radius: 18px;
            border: 4px solid rgba(255, 23, 68, 0.5);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55), 
                        border-color 0.3s ease;
            text-decoration: none;
            color: inherit;
            will-change: transform;
            cursor: pointer;
            position: relative;
            overflow: visible;
            box-shadow: 0 6px 24px rgba(255, 23, 68, 0.4),
                        0 3px 12px rgba(41, 121, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            clip-path: polygon(12px 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%, 0 12px);
        }
        .news-card::before {
            content: 'BREAKING';
            position: absolute;
            top: -10px;
            left: 12px;
            padding: 4px 12px;
            background: linear-gradient(135deg, #ff1744, #ff5252);
            color: white;
            font-weight: 900;
            font-size: 9px;
            letter-spacing: 1.5px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(255, 23, 68, 0.6);
        }
        .news-card:hover {
            border-color: rgba(255, 23, 68, 0.8);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.7), 
                        0 0 0 4px rgba(255, 23, 68, 0.6),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateX(8px) scale(1.02);
            filter: brightness(1.1);
        }
        @keyframes newsSlideIn {
            0% { transform: translateX(0) scale(1); }
            40% { transform: translateX(12px) scale(1.04) rotate(1deg); }
            70% { transform: translateX(6px) scale(1.02) rotate(-0.5deg); }
            100% { transform: translateX(8px) scale(1.03) rotate(0deg); }
        }
        .news-icon {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-size: 24px;
            flex-shrink: 0;
            position: relative;
            filter: brightness(1) drop-shadow(0 0 4px currentColor);
            transition: filter 0.3s ease;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        .news-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .news-icon i {
            position: relative;
            z-index: 1;
        }
        .news-icon:hover {
            filter: brightness(1.3) drop-shadow(0 0 12px currentColor);
        }
        .news-icon::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 10px;
            background: inherit;
            filter: blur(8px);
            opacity: 0.4;
            z-index: -1;
        }
        .news-icon.type-game_update { background: rgba(0, 212, 255, 0.15); color: var(--primary); }
        .news-icon.type-trend { background: rgba(255, 107, 53, 0.15); color: var(--accent); }
        .news-icon.type-tip { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .news-icon.type-community { background: rgba(124, 58, 237, 0.15); color: var(--secondary); }
        .news-content {
            flex: 1;
            min-width: 0;
        }
        .news-title {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--text-bright);
            margin-bottom: 4px;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.7),
                         -1px -1px 0 rgba(255, 255, 255, 0.1);
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .news-description {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .news-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .news-source {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        footer { 
            text-align: center; 
            padding: 32px 24px 24px; 
            color: var(--text-muted); 
            font-size: 0.85rem; 
            border-top: 1px solid var(--border);
        }
        footer a { 
            color: var(--primary); 
            text-decoration: none; 
            font-weight: 600;
        }
        footer a:hover { 
            color: var(--text-bright);
        }
        @media (max-width: 1400px) {
            .wrapper { 
                grid-template-columns: 1fr; 
                min-height: auto;
            }
            .sidebar-panel {
                position: relative;
                height: auto;
                max-height: 600px;
                top: 0;
            }
        }
        @media (max-width: 768px) {
            .stats-grid { 
                grid-template-columns: repeat(2, 1fr); 
            }
            .builders-grid { 
                grid-template-columns: 1fr; 
            }
            .stat-card .value { 
                font-size: 1.75rem; 
            }
            header.hero {
                flex-direction: column;
                align-items: flex-start;
                padding: 20px;
            }
            .podium-container {
                flex-direction: column;
                align-items: center;
            }
            .podium-card {
                width: 100%;
                max-width: 300px;
            }
            .podium-card.rank-1,
            .podium-card.rank-2,
            .podium-card.rank-3 {
                order: initial;
            }
            .content-grid {
                grid-template-columns: 1fr;
            }
            .sidebar-panel {
                max-height: 70vh;
                min-height: 400px;
            }
        }
        @media (max-width: 480px) { 
            .stats-grid { 
                grid-template-columns: 1fr; 
            } 
            .wrapper {
                padding: 12px;
                gap: 12px;
            }
            .glass {
                padding: 12px;
                border-radius: 12px;
            }
            .logo-text h1 {
                font-size: 1.5rem;
            }
            .logo-icon {
                width: 48px;
                height: 48px;
                font-size: 24px;
            }
            .section-title {
                font-size: 1rem;
            }
            .sidebar-panel {
                max-height: 80vh;
                min-height: 350px;
            }
            .feed-header {
                margin-bottom: 12px;
                padding-bottom: 12px;
            }
        }
        .skeleton { 
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%); 
            background-size: 200% 100%; 
            animation: skeletonShimmer 1.5s infinite; 
            border-radius: 8px; 
        }
        @keyframes skeletonShimmer { 
            0% { background-position: 200% 0; } 
            100% { background-position: -200% 0; } 
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Discord Join Button Animation */
        @keyframes discordPulse {
            0%, 100% { 
                opacity: 0; 
                transform: scale(0.95); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1.05); 
            }
        }
        
        .discord-join-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 0 #3c44a8, 0 12px 30px rgba(88,101,242,0.7), inset 0 3px 0 rgba(255,255,255,0.4);
        }
        
        .discord-join-btn:active {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 0 #3c44a8, 0 6px 15px rgba(88,101,242,0.6), inset 0 2px 0 rgba(255,255,255,0.3);
        }
        
        /* Premium ad carousel effects */
        .premium-ad-carousel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .premium-ad-carousel:hover {
            box-shadow: 0 16px 48px rgba(255, 23, 68, 0.5), 
                        0 0 0 3px rgba(255, 255, 255, 0.2),
                        inset 0 2px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .premium-ad-dot:hover {
            background: var(--primary) !important;
            transform: scale(1.2);
            box-shadow: 0 0 16px var(--primary-glow) !important;
        }
        
        /* Responsive Design */
        @media (max-width: 1400px) {
            .wrapper {
                grid-template-columns: 1fr 520px;
                gap: 20px;
            }
            .premium-ad-carousel {
                height: 180px !important;
            }
        }
        
        @media (max-width: 1200px) {
            .wrapper {
                grid-template-columns: 1fr;
                padding: 16px;
            }
            header {
                flex-wrap: wrap;
                gap: 12px !important;
                padding: 16px !important;
                min-height: auto !important;
            }
            .sidebar-panel {
                grid-column: 1;
            }
            .premium-ad-carousel {
                height: 160px !important;
            }
            .premium-ad-carousel button {
                width: 38px !important;
                height: 38px !important;
                font-size: 1.1rem !important;
            }
        }
        
        @media (max-width: 768px) {
            .wrapper {
                padding: 12px;
                gap: 16px;
            }
            header {
                padding: 12px !important;
            }
            .logo-text h1 {
                font-size: 1.25rem !important;
            }
            .logo-text .tagline {
                font-size: 0.7rem !important;
            }
            .discord-join-btn {
                padding: 10px 16px !important;
                font-size: 0.85rem !important;
                gap: 8px !important;
            }
            .discord-join-btn i {
                font-size: 1.1rem !important;
            }
            .discord-join-btn span {
                display: none;
            }
            .discord-join-btn::after {
                content: 'JOIN';
                text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                letter-spacing: 0.5px;
            }
            .logo-icon img {
                width: 28px !important;
                height: 28px !important;
            }
            .premium-ad-carousel {
                height: 140px !important;
            }
            .premium-ad-carousel button {
                display: none !important;
            }
            #adButtonsContainer button,
            #adButtonsContainer a {
                padding: 10px 18px !important;
                font-size: 0.85rem !important;
            }
            #adButtonsContainer .ad-mute-button {
                width: 42px !important;
                height: 42px !important;
                font-size: 1rem !important;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            .builders-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        @media (max-width: 480px) {
            .wrapper {
                padding: 8px;
                gap: 12px;
            }
            header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px !important;
            }
            .premium-ad-carousel {
                height: 120px !important;
            }
            #adControlsContainer {
                flex-wrap: wrap !important;
            }
            #adButtonsContainer button,
            #adButtonsContainer a {
                padding: 8px 16px !important;
                font-size: 0.8rem !important;
            }
            #adButtonsContainer .ad-mute-button {
                width: 38px !important;
                height: 38px !important;
                font-size: 0.95rem !important;
            }
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            .builders-grid {
                grid-template-columns: 1fr !important;
            }
            .content-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        .header-ad-dot:hover {
            transform: scale(1.2);
            filter: brightness(1.2);
        }
        
        /* News toggle button bounce */
        #toggleNews:hover {
            transform: scale(1.08) !important;
            box-shadow: 0 6px 20px rgba(255,23,68,0.5) !important;
            filter: brightness(1.1);
        }
        
        #toggleNews:active {
            transform: scale(0.95) !important;
        }

        /* Authentication Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .auth-modal.show {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .auth-modal-content {
            background: linear-gradient(135deg, rgba(20, 30, 50, 0.95), rgba(30, 40, 60, 0.95));
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9), 0 0 40px rgba(255, 23, 68, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.4s ease;
            position: relative;
        }
        .auth-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .auth-modal-close:hover {
            background: rgba(255, 23, 68, 0.8);
            transform: rotate(90deg);
        }
        .auth-modal-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--text-bright);
            margin-bottom: 8px;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.8);
        }
        .auth-modal-subtitle {
            color: var(--text-muted);
            margin-bottom: 24px;
            font-size: 0.9rem;
        }
        .auth-form-group {
            margin-bottom: 16px;
        }
        .auth-form-label {
            display: block;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 0.875rem;
        }
        .auth-form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(40, 50, 70, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text);
            font-size: 0.9rem;
            font-family: 'Fredoka', sans-serif;
            transition: all 0.3s ease;
            outline: none;
            box-sizing: border-box;
        }
        .auth-form-input:focus {
            background: rgba(50, 60, 80, 0.8);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 23, 68, 0.2);
        }
        .auth-form-input.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        .auth-error-msg {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }
        .auth-error-msg.show {
            display: block;
        }
        .auth-submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #FF1744, #ff5252);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: white;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 4px 0 #c41c3a, 0 6px 16px rgba(255,23,68,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .auth-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #c41c3a, 0 8px 20px rgba(255,23,68,0.6), inset 0 2px 0 rgba(255,255,255,0.3);
        }
        .auth-submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 0 #c41c3a, 0 4px 12px rgba(255,23,68,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
        }
        .auth-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        .auth-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
        }
        .auth-link:hover {
            color: var(--text-bright);
        }
        .profile-pic-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .profile-pic-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--primary);
            object-fit: cover;
            box-shadow: 0 0 20px rgba(255, 23, 68, 0.4);
        }
        .profile-pic-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .profile-pic-btn:hover {
            background: rgba(255, 23, 68, 0.6);
        }
        .username-check {
            font-size: 0.8rem;
            margin-top: 4px;
        }
        .username-check.available {
            color: var(--success);
        }
        .username-check.taken {
            color: var(--danger);
        }
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #c41c3a, 0 8px 20px rgba(255,23,68,0.6), inset 0 2px 0 rgba(255,255,255,0.3);
        }
        .auth-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 0 #c41c3a, 0 4px 12px rgba(255,23,68,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
        }
        .auth-social-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            filter: brightness(1.1);
        }
        .auth-social-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
    <script>
        // Make upload modal function available immediately
        window.openUploadModal = function() {
            if (!BUILD_MUSEUM_ENABLED) {
                alert('Build Museum is temporarily disabled.');
                return;
            }
            // Check if user is signed in
            if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                alert('Please sign in to upload builds!');
                return;
            }
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'build-modal show';
            modal.innerHTML = `
                <div class="build-modal-content" style="max-width: 600px; background: linear-gradient(135deg, rgba(30, 40, 60, 0.98), rgba(20, 30, 50, 0.98)); border: 3px solid rgba(255, 23, 68, 0.4); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 23, 68, 0.3);">
                    <button class="build-modal-close" onclick="this.closest('.build-modal').remove()" aria-label="Close upload modal" title="Close">√ó</button>
                    
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="display: inline-flex; align-items: center; justify-content: center; width: 70px; height: 70px; background: linear-gradient(135deg, #FF1744, #FF5252); border-radius: 50%; margin-bottom: 16px; box-shadow: 0 8px 24px rgba(255, 23, 68, 0.5);">
                            <i class="fas fa-upload" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h2 style="margin: 0; color: var(--text-bright); font-size: 1.8rem; font-weight: 900; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);">
                            Share Your Build
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">Show off your amazing Bloxburg creation to the community!</p>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.05);">
                            <label for="buildTitle" style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 800; color: var(--text-bright); font-size: 0.95rem;">
                                <i class="fas fa-heading" style="color: var(--primary);"></i>
                                Build Title
                            </label>
                            <input id="buildTitle" type="text" placeholder="e.g., Modern Luxury Villa" style="width: 100%; padding: 14px; border-radius: 10px; border: 2px solid rgba(255, 255, 255, 0.15); background: rgba(0, 0, 0, 0.4); color: var(--text-bright); font-size: 1rem; font-weight: 600; transition: all 0.3s ease;" maxlength="60" onfocus="this.style.borderColor='rgba(255, 23, 68, 0.6)'" onblur="this.style.borderColor='rgba(255, 255, 255, 0.15)'" aria-label="Build title" title="Enter your build title">
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; text-align: right;"><span id="titleCount">0</span>/60</p>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.05);">
                            <label for="buildDescription" style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 800; color: var(--text-bright); font-size: 0.95rem;">
                                <i class="fas fa-align-left" style="color: var(--primary);"></i>
                                Description
                            </label>
                            <textarea id="buildDescription" placeholder="Describe your build: design style, features, time spent building..." style="width: 100%; padding: 14px; border-radius: 10px; border: 2px solid rgba(255, 255, 255, 0.15); background: rgba(0, 0, 0, 0.4); color: var(--text-bright); font-size: 0.95rem; min-height: 100px; resize: vertical; font-family: inherit; transition: all 0.3s ease;" maxlength="500" onfocus="this.style.borderColor='rgba(255, 23, 68, 0.6)'" onblur="this.style.borderColor='rgba(255, 255, 255, 0.15)'" aria-label="Build description" title="Describe your build"></textarea>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; text-align: right;"><span id="descCount">0</span>/500</p>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.05);">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 800; color: var(--text-bright); font-size: 0.95rem;">
                                <i class="fas fa-image" style="color: var(--primary);"></i>
                                Media File
                            </label>
                            <div style="position: relative;">
                                <input id="buildFile" type="file" accept="image/*,video/*" style="width: 100%; padding: 14px; border-radius: 10px; border: 2px dashed rgba(255, 23, 68, 0.4); background: rgba(0, 0, 0, 0.4); color: var(--text-bright); font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease;" onchange="document.getElementById('fileName').textContent = this.files[0]?.name || 'No file chosen'">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                                <i class="fas fa-file" style="color: var(--text-muted); font-size: 0.9rem;"></i>
                                <span id="fileName" style="font-size: 0.85rem; color: var(--text-muted);">No file chosen</span>
                            </div>
                            <div style="display: flex; gap: 16px; margin-top: 10px; font-size: 0.75rem; color: var(--text-muted);">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                    Images: Max 5MB
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                    Videos: Max 50MB, 30s
                                </div>
                            </div>
                        </div>
                        
                        <button id="uploadSubmitBtn" onclick="if(window.handleBuildUpload) window.handleBuildUpload()" style="background: linear-gradient(135deg, #FF1744, #FF5252); border: 3px solid rgba(255, 255, 255, 0.3); color: white; padding: 16px; border-radius: 12px; cursor: pointer; font-weight: 900; font-size: 1.1rem; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); box-shadow: 0 6px 0 #c41c3a, 0 8px 24px rgba(255, 23, 68, 0.6), inset 0 2px 0 rgba(255, 255, 255, 0.3); text-transform: uppercase; letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 0 #c41c3a, 0 10px 28px rgba(255, 23, 68, 0.7), inset 0 2px 0 rgba(255, 255, 255, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 0 #c41c3a, 0 8px 24px rgba(255, 23, 68, 0.6), inset 0 2px 0 rgba(255, 255, 255, 0.3)'">
                            <i class="fas fa-cloud-upload-alt"></i> Upload Build
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add character counters
            document.getElementById('buildTitle').addEventListener('input', (e) => {
                document.getElementById('titleCount').textContent = e.target.value.length;
            });
            document.getElementById('buildDescription').addEventListener('input', (e) => {
                document.getElementById('descCount').textContent = e.target.value.length;
            });
        }
    </script>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <button class="auth-modal-close" onclick="closeAuthModal()" aria-label="Close authentication modal" title="Close">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- Sign Up Form -->
            <div id="signupForm" style="display: none;">
                <h2 class="auth-modal-title">Create Account</h2>
                <p class="auth-modal-subtitle">Join the Crumbl Crafts community</p>
                
                <div class="auth-form-group">
                    <label class="auth-form-label" for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" class="auth-form-input" placeholder="Username (no spaces)" maxlength="20" oninput="validateUsernameInput(this)" aria-label="Username" title="Enter your username">
                    <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">3-20 characters, no spaces allowed</p>
                    <div id="usernameCheck" class="username-check"></div>
                    <div id="signupUsernameError" class="auth-error-msg"></div>
                </div>
                
                <div class="auth-form-group">
                    <label class="auth-form-label" for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="auth-form-input" placeholder="your@email.com" aria-label="Email address" title="Enter your email address">
                    <div id="signupEmailError" class="auth-error-msg"></div>
                </div>
                
                <div class="auth-form-group">
                    <label class="auth-form-label" for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="auth-form-input" placeholder="Minimum 6 characters" aria-label="Password" title="Enter your password">
                    <div id="signupPasswordError" class="auth-error-msg"></div>
                </div>
                
                <div class="auth-form-group">
                    <label class="auth-form-label" for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="auth-form-input" placeholder="Re-enter password" aria-label="Confirm password" title="Re-enter your password">
                    <div id="signupConfirmError" class="auth-error-msg"></div>
                </div>
                
                <div class="auth-form-group">
                    <label class="auth-form-label" for="signupProfilePic">Profile Picture (Optional)</label>
                    <div class="profile-pic-upload">
                        <img id="signupProfilePreview" class="profile-pic-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23333'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23fff' font-size='40' font-family='Arial'%3E%3F%3C/text%3E%3C/svg%3E" alt="Profile">
                        <input type="file" id="signupProfilePic" accept="image/*" style="display: none;" aria-label="Upload profile picture" title="Choose a profile picture">
                        <button type="button" class="profile-pic-btn" onclick="document.getElementById('signupProfilePic').click()" aria-label="Upload photo" title="Upload profile photo">
                            <i class="fas fa-upload"></i> Upload Photo
                        </button>
                    </div>
                </div>
                
                <button id="signupSubmitBtn" class="auth-submit-btn" onclick="handleSignup()">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
                
                <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0;">
                    <div style="flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1);"></div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">OR</span>
                    <div style="flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1);"></div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="auth-social-btn" onclick="handleGoogleSignIn()" style="background: linear-gradient(135deg, #4285F4, #357AE8); border: none; color: white; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fab fa-google"></i> Continue with Google
                    </button>
                    <button class="auth-social-btn" onclick="handleAnonymousSignIn()" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text); padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-user-secret"></i> Continue as Guest
                    </button>
                </div>
                
                <div class="auth-divider" style="margin-top: 16px;">
                    Already have an account? <span class="auth-link" onclick="showSignIn()">Sign In</span>
                </div>
            </div>
            
            <!-- Sign In Form -->
            <div id="signinForm" style="display: none;">
                <h2 class="auth-modal-title">Welcome Back</h2>
                <p class="auth-modal-subtitle">Sign in to your account</p>
                
                <div class="auth-form-group">
                    <label class="auth-form-label">Email</label>
                    <input type="email" id="signinEmail" class="auth-form-input" placeholder="your@email.com">
                    <div id="signinEmailError" class="auth-error-msg"></div>
                </div>
                
                <div class="auth-form-group">
                    <label class="auth-form-label">Password</label>
                    <input type="password" id="signinPassword" class="auth-form-input" placeholder="Enter your password">
                    <div id="signinPasswordError" class="auth-error-msg"></div>
                </div>
                
                <button id="signinSubmitBtn" class="auth-submit-btn" onclick="handleSignIn()">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
                
                <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0;">
                    <div style="flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1);"></div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">OR</span>
                    <div style="flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1);"></div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="auth-social-btn" onclick="handleGoogleSignIn()" style="background: linear-gradient(135deg, #4285F4, #357AE8); border: none; color: white; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fab fa-google"></i> Continue with Google
                    </button>
                    <button class="auth-social-btn" onclick="handleEmailLinkSignIn()" style="background: linear-gradient(135deg, #7C3AED, #6D28D9); border: none; color: white; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-envelope"></i> Sign In with Email Link
                    </button>
                    <button class="auth-social-btn" onclick="handleAnonymousSignIn()" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text); padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-user-secret"></i> Continue as Guest
                    </button>
                </div>
                
                <div class="auth-divider" style="margin-top: 16px;">
                    <span class="auth-link" onclick="showForgotPassword()">Forgot Password?</span> ¬∑ 
                    <span class="auth-link" onclick="showSignUp()">Create Account</span>
                </div>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" style="display: none;">
                <h2 class="auth-modal-title">Reset Password</h2>
                <p class="auth-modal-subtitle">We'll send you a reset link</p>
                
                <div class="auth-form-group">
                    <label class="auth-form-label">Email</label>
                    <input type="email" id="resetEmail" class="auth-form-input" placeholder="your@email.com">
                    <div id="resetEmailError" class="auth-error-msg"></div>
                </div>
                
                <button id="resetSubmitBtn" class="auth-submit-btn" onclick="handlePasswordReset()">
                    <i class="fas fa-envelope"></i> Send Reset Link
                </button>
                
                <div class="auth-divider">
                    <span class="auth-link" onclick="showSignIn()">Back to Sign In</span>
                </div>
            </div>

            <!-- Profile Edit Form -->
            <div id="profileEditForm" style="display: none;">
                <h2 class="auth-modal-title">Edit Profile</h2>
                <p class="auth-modal-subtitle">Update your information</p>
                
                <div class="auth-form-group">
                    <label class="auth-form-label">Profile Picture</label>
                    <div class="profile-pic-upload">
                        <img id="editProfilePreview" class="profile-pic-preview" src="" alt="Profile">
                        <input type="file" id="editProfilePic" accept="image/*" style="display: none;">
                        <button type="button" class="profile-pic-btn" onclick="document.getElementById('editProfilePic').click()">
                            <i class="fas fa-camera"></i> Change Photo
                        </button>
                    </div>
                </div>
                
                <div class="auth-form-group">
                    <label class="auth-form-label">Username</label>
                    <input type="text" id="editUsername" class="auth-form-input" placeholder="alphanumeric and _ only" maxlength="20" oninput="validateUsernameInput(this)">
                    <div id="editUsernameCheck" class="username-check"></div>
                    <div id="editUsernameError" class="auth-error-msg"></div>
                </div>
                
                <button id="profileSaveBtn" class="auth-submit-btn" onclick="handleProfileUpdate()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                
                <div class="auth-divider">
                    <span class="auth-link" onclick="handleSignOut()">Sign Out</span>
                </div>
            </div>
        </div>
    </div>
<body>
    <div class="wrapper">
        <div class="main-content">
            <header class="glass hero" style="display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 16px 24px; min-height: 80px;">
                <div class="logo-container" style="flex-shrink: 0;">
                    <div class="logo-icon">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23D2691E'/%3E%3Ccircle cx='30' cy='35' r='6' fill='%23654321'/%3E%3Ccircle cx='65' cy='40' r='5' fill='%23654321'/%3E%3Ccircle cx='45' cy='55' r='7' fill='%23654321'/%3E%3Ccircle cx='70' cy='65' r='5' fill='%23654321'/%3E%3Ccircle cx='30' cy='65' r='4' fill='%23654321'/%3E%3C/svg%3E" alt="Cookie" style="width: 32px; height: 32px;" />
                    </div>
                    <div class="logo-text">
                        <h1 style="font-size: 1.5rem;">Crumbl Crafts</h1>
                        <p class="tagline" style="font-size: 0.8rem;">Premium Bloxburg Builder Network</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
                        <div class="status-badge" id="statusBadge">
                            <span class="status-dot" id="statusDot"></span>
                            <span id="statusText">LIVE</span>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; margin-left: 4px;">
                            <span id="latencyDisplay">‚Äî</span>
                        </div>
                    </div>
                    <a href="https://discord.gg/fqQfmSwfMj" target="_blank" class="discord-join-btn" style="text-decoration: none; display: flex; align-items: center; gap: 8px; padding: 10px 18px; background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%); border: 3px solid rgba(255,255,255,0.3); border-radius: 12px; color: white; font-weight: 800; font-size: 0.85rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); box-shadow: 0 6px 0 #3c44a8, 0 8px 20px rgba(88,101,242,0.5), inset 0 2px 0 rgba(255,255,255,0.3); position: relative; overflow: hidden;">
                        <i class="fab fa-discord" style="font-size: 1.1rem;"></i>
                        <span>DISCORD</span>
                    </a>
                    <button id="authButton" class="auth-btn" onclick="showSignUp()" style="display: flex; align-items: center; gap: 8px; padding: 10px 18px; background: linear-gradient(135deg, #FF1744, #ff5252); border: 3px solid rgba(255,255,255,0.3); border-radius: 12px; color: white; font-weight: 800; font-size: 0.85rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); box-shadow: 0 4px 0 #c41c3a, 0 6px 16px rgba(255,23,68,0.5), inset 0 2px 0 rgba(255,255,255,0.3);">
                        <i class="fas fa-user-plus"></i>
                        <span>SIGN UP</span>
                    </button>
                    <div id="userProfile" onclick="showProfileEdit()" style="display: none; align-items: center; gap: 10px; cursor: pointer;">
                        <img id="userAvatar" src="" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--primary); box-shadow: 0 0 12px rgba(255,23,68,0.5);">
                        <span id="userName" style="font-weight: 700; color: var(--text-bright);"></span>
                    </div>
                </div>
            </header>

            <!-- Premium Ad Showcase - Attached Below Header (Dynamic) -->
            <section id="adSection" style="padding: 0; overflow: visible; position: relative; margin: -12px 0 8px 0; display: none;">
                <!-- Ad Section Header -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding: 0 4px;">
                    <h3 style="font-size: 0.9rem; font-weight: 800; color: var(--text-bright); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; text-shadow: 2px 2px 0 rgba(0,0,0,0.7);">
                        <i class="fas fa-ad" style="color: var(--primary);"></i>
                        <span>Featured Ads</span>
                    </h3>
                    <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Sponsored</span>
                </div>
                <div class="premium-ad-carousel" id="premiumAdCarousel" style="position: relative; width: 100%; height: 200px; background: linear-gradient(135deg, #0a0f1a 0%, #1a2030 50%, #0a0f1a 100%); border-radius: 20px; overflow: hidden; box-shadow: 0 8px 0 rgba(0,0,0,0.7), 0 0 40px rgba(255,23,68,0.5), inset 0 3px 0 rgba(255,255,255,0.08); border: 4px solid #FF1744; transform: translateZ(0);">
                    
                    <!-- Subtle Halftone Pattern -->
                    <div style="position: absolute; inset: 0; background-image: radial-gradient(circle, rgba(255,23,68,0.06) 1px, transparent 1px); background-size: 8px 8px; z-index: 2; pointer-events: none; opacity: 0.5;"></div>
                    
                    <!-- Ad Slides Container (dynamically populated) -->
                    <div id="adSlidesContainer"></div>
                    
                    <!-- Compact Navigation Arrows (hidden for single ad) -->
                    <button id="adNavPrev" onclick="navigatePremiumAd(-1)" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, rgba(255,23,68,0.95), rgba(255,52,82,0.95)); backdrop-filter: blur(8px); border: 3px solid rgba(255,255,255,0.9); color: white; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 1.1rem; display: none; align-items: center; justify-content: center; z-index: 10; transition: all 0.25s ease; box-shadow: 0 4px 0 rgba(0,0,0,0.8), 0 0 20px rgba(255,23,68,0.6), inset 0 2px 0 rgba(255,255,255,0.3);" onmouseover="this.style.transform='translateY(-50%) scale(1.1)'; this.style.boxShadow='0 6px 0 rgba(0,0,0,0.9), 0 0 30px rgba(255,23,68,0.8), inset 0 3px 0 rgba(255,255,255,0.4)';" onmouseout="this.style.transform='translateY(-50%) scale(1)'; this.style.boxShadow='0 4px 0 rgba(0,0,0,0.8), 0 0 20px rgba(255,23,68,0.6), inset 0 2px 0 rgba(255,255,255,0.3)';">
                        <i class="fas fa-chevron-left" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></i>
                    </button>
                    <button id="adNavNext" onclick="navigatePremiumAd(1)" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, rgba(255,23,68,0.95), rgba(255,52,82,0.95)); backdrop-filter: blur(8px); border: 3px solid rgba(255,255,255,0.9); color: white; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 1.1rem; display: none; align-items: center; justify-content: center; z-index: 10; transition: all 0.25s ease; box-shadow: 0 4px 0 rgba(0,0,0,0.8), 0 0 20px rgba(255,23,68,0.6), inset 0 2px 0 rgba(255,255,255,0.3);" onmouseover="this.style.transform='translateY(-50%) scale(1.1)'; this.style.boxShadow='0 6px 0 rgba(0,0,0,0.9), 0 0 30px rgba(255,23,68,0.8), inset 0 3px 0 rgba(255,255,255,0.4)';" onmouseout="this.style.transform='translateY(-50%) scale(1)'; this.style.boxShadow='0 4px 0 rgba(0,0,0,0.8), 0 0 20px rgba(255,23,68,0.6), inset 0 2px 0 rgba(255,255,255,0.3)';">
                        <i class="fas fa-chevron-right" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></i>
                    </button>
                    
                </div>
                <!-- Compact Indicator Dots & Buttons - Below Ad -->
                <div id="adControlsContainer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <!-- Buttons Container (left side) -->
                    <div id="adButtonsContainer" style="display: flex; gap: 10px; align-items: center;"></div>
                    
                    <!-- Dots Container (center) -->
                    <div id="adDotsContainer" style="display: none; justify-content: center; position: absolute; left: 50%; transform: translateX(-50%);">
                        <div id="adDotsWrapper" style="display: flex; gap: 8px; background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(20,20,30,0.9)); padding: 8px 14px; border-radius: 14px; border: 3px solid rgba(255,255,255,0.9); box-shadow: 0 4px 0 rgba(0,0,0,0.8), 0 0 20px rgba(255,23,68,0.5), inset 0 2px 0 rgba(255,255,255,0.1);">
                            <!-- Dots dynamically populated -->
                        </div>
                    </div>
                </div>
            </section>

            <section class="glass" style="margin-bottom: 16px;">
                <div class="stats-grid" id="statsGrid"></div>
            </section>

            <section class="glass" style="margin-bottom: 16px;">
                <h2 class="section-title">
                    <i class="fas fa-trophy"></i>
                    Top Builders
                </h2>
                <p class="section-subtitle">Our highest-rated builders this month</p>
                <div class="builders-grid" id="buildersGrid"></div>
            </section>

            <div class="content-grid">
                <section class="glass news-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                        <div>
                            <h2 class="section-title">
                                <i class="fas fa-newspaper"></i>
                                Bloxburg News & Trends
                            </h2>
                            <p class="section-subtitle">Latest updates, trends & community highlights</p>
                        </div>
                        <button id="toggleNews" style="background: rgba(255, 23, 68, 0.15); border: 3px solid rgba(255, 23, 68, 0.4); color: var(--primary); padding: 10px 18px; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); text-shadow: 2px 2px 0 rgba(0,0,0,0.5); box-shadow: 0 4px 12px rgba(255,23,68,0.3);">
                            <i class="fas fa-chevron-down" id="newsChevron"></i> <span id="newsButtonText">SHOW NEWS</span>
                        </button>
                    </div>
                    <div class="news-list-wrapper" id="newsListWrapper" style="max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, margin-top 0.3s ease; opacity: 0; margin-top: 0;">
                        <div style="padding: 40px 20px; text-align: center;">
                            <i class="fas fa-newspaper" style="font-size: 3rem; color: var(--primary); text-shadow: 2px 2px 0 rgba(0,0,0,0.7), -1px -1px 0 rgba(255,255,255,0.1); margin-bottom: 16px; display: block;"></i>
                            <h3 style="font-weight: 800; font-size: 1.5rem; color: var(--text-bright); text-shadow: 2px 2px 0 rgba(0,0,0,0.7), -1px -1px 0 rgba(255,255,255,0.1); margin-bottom: 12px;">Coming Soon! üöÄ</h3>
                            <p style="color: var(--text-muted); font-size: 0.95rem; line-height: 1.6;">We're working on bringing you the latest Bloxburg news, trends, and community highlights.<br>Stay tuned for exciting updates!</p>
                        </div>
                    </div>
                </section>

                <section class="glass">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                        <div>
                            <h2 class="section-title">
                                <i class="fas fa-landmark"></i>
                                Build Museum
                            </h2>
                            <p class="section-subtitle">Showcase your amazing Bloxburg builds</p>
                        </div>
                        <button id="uploadBuildBtn" onclick="openUploadModal()" style="background: linear-gradient(135deg, #FF1744, #FF5252); border: none; color: white; padding: 10px 18px; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 0.85rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 23, 68, 0.4); display: flex; align-items: center; gap: 8px;" data-feature="build-museum-btn">
                            <i class="fas fa-upload"></i> Share Build
                        </button>
                    </div>
                    <div class="build-museum-grid" id="buildMuseumGrid" data-feature="build-museum-grid"></div>
                </section>
            </div>

            <footer>
                <p>
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23D2691E'/%3E%3Ccircle cx='30' cy='35' r='6' fill='%23654321'/%3E%3Ccircle cx='65' cy='40' r='5' fill='%23654321'/%3E%3Ccircle cx='45' cy='55' r='7' fill='%23654321'/%3E%3Ccircle cx='70' cy='65' r='5' fill='%23654321'/%3E%3Ccircle cx='30' cy='65' r='4' fill='%23654321'/%3E%3C/svg%3E" alt="Cookie" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;" />
                    Powered by <strong>Crumbl Crafts</strong> ¬∑ Synced with Discord
                </p>
            </footer>
        </div>

        <aside class="sidebar-panel glass">
            <div class="activity-feed-container">
                <div class="feed-header">
                    <div>
                        <h2 class="section-title" style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-rss" style="font-size: 1rem;"></i>
                            <span>Activity Feed</span>
                        </h2>
                        <p class="section-subtitle">Live ¬∑ 7d history</p>
                    </div>
                    <div class="feed-stats">
                        <div class="feed-stat">
                            <span style="font-size: 1.5rem; font-weight: 800; color: var(--primary);" id="activityCount">0</span>
                            <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700;">Events</span>
                        </div>
                    </div>
                </div>
                <div class="activity-list" id="activityList"></div>
            </div>

            <!-- Chat System Container -->
            <div class="chat-container">
                <div class="chat-header">
                    <div>
                        <h2 class="section-title" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="fas fa-comments" style="font-size: 1.2rem;"></i>
                            <span>Live Chat</span>
                            <span id="messageCount" style="font-size: 0.7rem; color: rgba(255,255,255,0.4); margin-left: auto;"></span>
                        </h2>
                        <div class="chat-channels">
                            <button class="chat-channel-btn active" data-channel="general" onclick="switchChatChannel('general')" title="General chat channel" aria-label="General chat">General</button>
                            <button class="chat-channel-btn" data-channel="builders" onclick="switchChatChannel('builders')" title="Builders chat channel" aria-label="Builders chat">Builders</button>
                            <button class="chat-channel-btn" data-channel="help" onclick="switchChatChannel('help')" title="Help chat channel" aria-label="Help chat">Help</button>
                        </div>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div style="position: relative;">
                    <div class="reply-preview" id="replyPreview">
                        <div class="reply-preview-text" id="replyPreviewText"></div>
                        <div class="reply-preview-close" onclick="cancelReply()">&times;</div>
                    </div>
                    <div class="emoji-picker" id="emojiPicker">
                        <div class="emoji-grid" id="emojiGrid"></div>
                    </div>
                    <div class="gif-picker" id="gifPicker">
                        <input type="text" class="gif-search" id="gifSearch" placeholder="Search GIFs...">
                        <div class="gif-grid" id="gifGrid"></div>
                    </div>
                    <div class="mention-autocomplete" id="mentionAutocomplete"></div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="toggleEmojiPicker()" aria-label="Add emoji" title="Add emoji">
                            <i class="fas fa-smile"></i> Emoji
                        </button>
                        <button class="chat-action-btn" onclick="toggleGifPicker()" aria-label="Add GIF" title="Add GIF">
                            <i class="fas fa-film"></i> GIF
                        </button>
                    </div>
                    <div class="chat-input-container">
                        <label for="chatInput" class="sr-only">Chat message</label>
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="500" aria-label="Type your chat message" title="Type your chat message">
                        <button id="chatSendBtn" class="chat-send-btn" aria-label="Send message" title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { getDatabase, ref, push, onChildAdded, onValue, off, serverTimestamp, limitToLast, query, get, set, update, child, orderByChild, endBefore, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updateProfile, signInAnonymously, GoogleAuthProvider, signInWithPopup, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, arrayUnion, serverTimestamp as firestoreTimestamp, query as firestoreQuery, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3iLtr9jkL6W2nD7U8yHIROe6fReD-fQs",
            authDomain: "crumblcrafts-b90cc.firebaseapp.com",
            projectId: "crumblcrafts-b90cc",
            storageBucket: "crumblcrafts-b90cc.appspot.com",
            messagingSenderId: "851356801084",
            appId: "1:851356801084:web:dcf29959d53a59d4e44b39",
            measurementId: "G-J4F5CKV6J3",
            databaseURL: "https://crumblcrafts-b90cc-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const firestore = getFirestore(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDb = database;
        window.firebaseAuth = auth;
        window.firebaseStorage = storage;
        window.firebaseAnalytics = analytics;
        window.firestore = firestore;
        
        // Make Firebase functions globally accessible
        window.storageRef = storageRef;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.collection = collection;
        window.addDoc = addDoc;
        window.firestoreTimestamp = firestoreTimestamp;

        // Current user state
        let currentUser = null;
        
        // Username validation
        function validateUsername(username) {
            // Remove spaces
            username = username.replace(/\s+/g, '');
            // Only allow alphanumeric, underscore, and hyphen
            username = username.replace(/[^a-zA-Z0-9_-]/g, '');
            // Limit length to 3-20 characters
            if (username.length < 3) username = username.padEnd(3, '0');
            if (username.length > 20) username = username.substring(0, 20);
            return username;
        }

        // Chat System with Firebase
        let chatMessagesRef = ref(database, 'chat/general/messages');
        // `chatMessages` may be queried before DOM ready; use a mutable reference and resolve when initializing
        let chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        
        // Infinite scroll state for loading older messages
        let isLoadingOlderMessages = false;
        let oldestMessageTimestamp = null;
        let hasMoreMessages = true;

        // Generate random user ID if not exists
        let userId = localStorage.getItem('chatUserId');
        if (!userId) {
            userId = 'User_' + Math.random().toString(36).substr(2, 6);
            localStorage.setItem('chatUserId', userId);
        }

        // Advanced chat state
        let replyingTo = null;
        const TENOR_API_KEY = 'AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCF0'; // Free Tenor API key
        
        // Send message function
        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            
            // Require sign-in
            if (!currentUser) {
                alert('Please sign in to chat.');
                openAuthModal();
                return;
            }
            // Check cooldown
            const cooldownCheck = canSendMessage();
            if (!cooldownCheck.allowed) {
                alert(`Please wait ${cooldownCheck.secondsLeft} seconds before sending another message in this channel.`);
                return;
            }

            // Admin command handling (only for moderators)
            if (text.startsWith('/')) {
                handleCommand(text);
                chatInput.value = '';
                return;
            }

            const messageData = {
                author: userId, // fallback legacy username
                authorId: currentUser.uid,
                authorDisplayName: currentUser.displayName || currentUser.email,
                text: text,
                timestamp: serverTimestamp()
            };
            
            // Add reply info if replying
            if (replyingTo) {
                messageData.replyTo = {
                    author: replyingTo.author,
                    text: replyingTo.text.substring(0, 50)
                };
            }

            // Check if user is banned
            if (isUserBanned(userId)) {
                alert('You are banned from chat and cannot post.');
                return;
            }

            const newRef = push(chatMessagesRef, messageData);
            // Update spam tracker
            trackSpam(userId);
            return newRef;
            
            // Update last message time
            lastMessageTime[currentChannel] = Date.now();

            chatInput.value = '';
            cancelReply();
        }

        // New message tracking with optimization
        let lastSeenMessageTime = Date.now();
        let newMessageCount = 0;
        let hasScrolledToBottom = true;
        let messageCache = [];
        // Virtualization state
        let allMessages = [];
        let virtualStart = 0;
        let messageHeights = new Map();
        let visibleNodes = {};
        let nodePool = [];
        const VIRTUAL_CONFIG = {
            avgHeight: 72,
            overscan: 8,
            minWindow: 10
        };

        const POOL_MAX = 120;

        function computeWindowSize() {
            if (!chatMessages) return VIRTUAL_CONFIG.minWindow;
            const clientH = chatMessages.clientHeight || 400;
            const visible = Math.max(Math.ceil(clientH / VIRTUAL_CONFIG.avgHeight) + (VIRTUAL_CONFIG.overscan * 2), VIRTUAL_CONFIG.minWindow);
            return visible;
        }

        function getMessageHeightByIndex(idx) {
            const m = allMessages[idx];
            if (!m || !m.id) return VIRTUAL_CONFIG.avgHeight;
            const h = messageHeights.get(m.id);
            return h || VIRTUAL_CONFIG.avgHeight;
        }

        function computeTopHeight(startIndex) {
            // compute using known heights, fallback to average for unknowns
            let sum = 0;
            for (let i = 0; i < startIndex; i++) {
                sum += getMessageHeightByIndex(i);
            }
            return sum;
        }

        function recycleVisibleNodes(notDesired) {
            // notDesired is a Set of indices to evict
            for (const idxStr in visibleNodes) {
                const idx = parseInt(idxStr);
                if (notDesired.has(idx)) {
                    const nd = visibleNodes[idx];
                    if (nd && nd.parentNode) nd.parentNode.removeChild(nd);
                    // limit pool size
                    if (nodePool.length < POOL_MAX) {
                        nodePool.push(nd);
                    }
                    delete visibleNodes[idx];
                }
            }
        }

        function createOrUpdateNodeForIndex(idx) {
            const message = allMessages[idx];
            if (!message) return null;
            let el = visibleNodes[idx];
            if (el) return el;
            // Reuse from pool if possible
            if (nodePool.length > 0) {
                el = nodePool.pop();
                // Update content
                try { updateMessageElement(el, message); } catch(e) { el = createMessageElement(message); }
            } else {
                el = createMessageElement(message);
            }
            if (el) {
                visibleNodes[idx] = el;
            }
            return el;
        }

        function updateMessageElement(el, msg) {
            if (!el || !msg) return;
            el.setAttribute('data-id', msg.id || '');
            if (msg.replyTo) el.classList.add('reply'); else el.classList.remove('reply');
            const authorEl = el.querySelector('.chat-message-author');
            if (authorEl) {
                const display = msg.authorDisplayName || msg.author || 'Anonymous';
                authorEl.textContent = display;
            }
            const timeEl = el.querySelector('.chat-message-time');
            if (timeEl) {
                const ts = msg.timestamp ? new Date(msg.timestamp) : new Date();
                timeEl.textContent = ts.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }
            const textEl = el.querySelector('.chat-message-text');
            if (textEl) {
                const isGif = msg.text && (msg.text.includes('giphy.com') || msg.text.includes('tenor.com'));
                if (isGif) {
                    textEl.innerHTML = `<img src="${msg.text}" style="max-width:250px;max-height:250px;border-radius:8px;margin-top:4px" loading="lazy" decoding="async" alt="GIF">`;
                } else {
                    const sanitized = (msg.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    textEl.innerHTML = sanitized.replace(/@(\w+)/g, '<span class="chat-mention">@$1</span>');
                }
            }
            // Avatar update
            const avatarEl = el.querySelector('.chat-message-avatar');
            if (avatarEl) {
                if (msg.authorId) {
                    getUserProfile(msg.authorId).then(profile => {
                        if (!profile) return;
                        if (profile.photoURL) {
                            avatarEl.innerHTML = '';
                            const img = document.createElement('img');
                            img.src = profile.photoURL;
                            img.alt = profile.username || profile.displayName || 'User';
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.borderRadius = '50%';
                            avatarEl.appendChild(img);
                        }
                    }).catch(() => {});
                } else {
                    const initial = (msg.author || (msg.authorDisplayName || '')).charAt(0).toUpperCase() || '?';
                    avatarEl.textContent = initial;
                }
            }
            // Actions: rebuild reply/delete bindings
            const actions = el.querySelector('.message-actions');
            if (actions) {
                actions.innerHTML = '';
                const replyBtn = document.createElement('span');
                replyBtn.className = 'message-action-btn';
                replyBtn.textContent = '‚Ü© Reply';
                replyBtn.onclick = () => setReply(msg);
                actions.appendChild(replyBtn);

                const canDelete = (msg.author && (msg.author === userId)) || (typeof currentUser !== 'undefined' && currentUser && (msg.author === currentUser.uid || msg.author === currentUser.displayName || msg.author === currentUser.email));
                if (canDelete) {
                    const delBtn = document.createElement('span');
                    delBtn.className = 'message-action-btn';
                    delBtn.style.background = 'rgba(220, 53, 69, 0.25)';
                    delBtn.style.color = 'white';
                    delBtn.textContent = 'üóë Delete';
                    delBtn.onclick = async (e) => {
                        e.stopPropagation();
                        if (!msg.id) {
                            alert('Cannot delete this message (no id).');
                            return;
                        }
                        if (!confirm('Delete this message?')) return;
                        try {
                            await remove(child(ref(database, `chat/${currentChannel}/messages`), msg.id));
                            const elSel = document.querySelector(`.chat-message[data-id="${msg.id}"]`);
                            if (elSel) elSel.remove();
                        } catch (err) {
                            console.error('Failed to delete message', err);
                            alert('Failed to delete message. See console.');
                        }
                    };
                    actions.appendChild(delBtn);
                }
            }
        }

        function renderVirtualWindow() {
            if (!chatMessages) chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            const visibleCount = computeWindowSize();
            const start = Math.max(0, Math.min(virtualStart, Math.max(0, allMessages.length - visibleCount)));
            virtualStart = start;
            const end = Math.min(allMessages.length, start + visibleCount);

            // compute spacer heights (use per-message heights when available)
            const topHeight = computeTopHeight(start);
            let bottomHeight = 0;
            for (let i = end; i < allMessages.length; i++) bottomHeight += getMessageHeightByIndex(i);

            // build content fragment
            const frag = document.createDocumentFragment();

            const topSpacer = document.createElement('div');
            topSpacer.className = 'virtual-spacer top';
            topSpacer.style.height = topHeight + 'px';
            frag.appendChild(topSpacer);

            // Recycle nodes not in window
            const desired = new Set();
            for (let i = start; i < end; i++) desired.add(i);
            recycleVisibleNodes(desired);

            for (let i = start; i < end; i++) {
                const el = createOrUpdateNodeForIndex(i);
                if (el) frag.appendChild(el);
            }

            const bottomSpacer = document.createElement('div');
            bottomSpacer.className = 'virtual-spacer bottom';
            bottomSpacer.style.height = bottomHeight + 'px';
            frag.appendChild(bottomSpacer);

            // replace children (fast) - attach fragment but keep DOM nodes recycled
            chatMessages.innerHTML = '';
            chatMessages.appendChild(frag);
            // After render, measure heights and update averages
            requestAnimationFrame(() => {
                try {
                    const messageEls = chatMessages.querySelectorAll('.chat-message');
                    let totalMeasured = 0;
                    let count = 0;
                    messageEls.forEach((el) => {
                        const id = el.getAttribute('data-id');
                        if (!id) return;
                        const h = el.offsetHeight;
                        const prev = messageHeights.get(id) || 0;
                        if (prev !== h) messageHeights.set(id, h);
                        totalMeasured += h;
                        count++;
                    });
                    if (count > 0) {
                        const measured = Math.round(totalMeasured / count);
                        // Exponential moving average update
                        const alpha = 0.2;
                        VIRTUAL_CONFIG.avgHeight = Math.round((alpha * measured) + ((1 - alpha) * VIRTUAL_CONFIG.avgHeight));
                    }
                } catch (e) {
                    console.warn('Failed to measure virtual message heights', e);
                }
            });
            updateMessageCount();
        }
        let lastRenderedMessageCount = 0;
        
        // Throttle scroll event for performance
        let scrollTimeout;
        chatMessages.addEventListener('scroll', () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const isAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 50;
                if (isAtBottom && newMessageCount > 0) {
                    resetNewMessageCounter();
                }
                hasScrolledToBottom = isAtBottom;
            }, 100);
        });
        
        function showNewMessageCounter() {
            let counter = document.getElementById('newMessageCounter');
            if (!counter) {
                counter = document.createElement('div');
                counter.id = 'newMessageCounter';
                counter.className = 'new-messages-counter';
                counter.onclick = scrollToBottom;
                document.querySelector('.chat-container').appendChild(counter);
            }
            counter.textContent = `${newMessageCount} New Message${newMessageCount > 1 ? 's' : ''}`;
            counter.style.display = 'block';
        }
        
        function resetNewMessageCounter() {
            newMessageCount = 0;
            lastSeenMessageTime = Date.now();
            const counter = document.getElementById('newMessageCounter');
            if (counter) counter.style.display = 'none';
        }
        
        function scrollToBottom() {
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
            resetNewMessageCounter();
        }
        
        // Optimized message display with DocumentFragment
        // Update message count display
        function updateMessageCount() {
            const messageCount = chatMessages.querySelectorAll('.chat-message').length;
            const countElement = document.getElementById('messageCount');
            if (countElement) {
                countElement.textContent = `${messageCount} messages loaded`;
            }
        }

        // Moderation helpers
        function isModerator(uid) {
            if (!uid) return false;
            return window.moderators && window.moderators.has(uid);
        }

        function isUserBanned(id) {
            const ban = window.bannedUsers && window.bannedUsers[id];
            if (!ban) return false;
            const until = ban.bannedUntil || 0;
            return Date.now() < until;
        }

        function trackSpam(uid) {
            if (!uid) return;
            const now = Date.now();
            if (!spamTracker[uid]) spamTracker[uid] = [];
            spamTracker[uid].push(now);
            // prune old
            spamTracker[uid] = spamTracker[uid].filter(t => now - t <= SPAM_WINDOW_MS);
            if (spamTracker[uid].length > SPAM_THRESHOLD) {
                // Mark as spam: timeout user for 1 minute
                applyTimeoutToUser(uid, 60 * 1000, 'Auto-timeout: spam detected');
            }
        }

        async function applyTimeoutToUser(uid, durationMs, reason) {
            const until = Date.now() + durationMs;
            window.bannedUsers = window.bannedUsers || {};
            window.bannedUsers[uid] = { bannedUntil: until, reason: reason || 'timeout' };
            try {
                await set(ref(database, `bans/${uid}`), window.bannedUsers[uid]);
            } catch (e) {
                console.warn('Failed to persist ban:', e);
            }
        }

        async function removeMessageById(channel, msgId) {
            try {
                const msgRef = child(ref(database, `chat/${channel}/messages`), msgId);
                await remove(msgRef);
                // Also remove from DOM if present
                const el = document.querySelector(`.chat-message[data-id="${msgId}"]`);
                if (el) el.remove();
            } catch (e) {
                console.error('Failed to remove message:', e);
            }
        }

        // Admin/command handlers
        function handleCommand(text) {
            const parts = text.trim().split(/\s+/);
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);
            const uid = currentUser?.uid;
            if (!isModerator(uid)) {
                alert('You must be a moderator to run commands.');
                return;
            }

            if (cmd === '/purge') {
                const count = parseInt(args[0], 10) || 50;
                purgeMessages(count);
            } else if (cmd === '/ban') {
                const target = args[0];
                const minutes = parseInt(args[1], 10) || 60;
                banUser(target, minutes * 60 * 1000, args.slice(2).join(' ') || 'manual ban');
            } else if (cmd === '/timeout') {
                const target = args[0];
                const seconds = parseInt(args[1], 10) || 60;
                applyTimeoutToUser(target, seconds * 1000, args.slice(2).join(' ') || 'timeout');
            } else if (cmd === '/unban') {
                const target = args[0];
                unbanUser(target);
            } else {
                alert('Unknown command');
            }
        }

        async function purgeMessages(count) {
            // fetch last `count` keys and remove them
            try {
                const msgsRef = ref(database, `chat/${currentChannel}/messages`);
                const q = query(msgsRef, orderByChild('timestamp'), limitToLast(count));
                const snap = await get(q);
                const toDelete = [];
                snap.forEach(s => toDelete.push(s.key));
                for (const id of toDelete) {
                    await remove(child(msgsRef, id));
                }
                alert(`Purged ${toDelete.length} messages from ${currentChannel}`);
            } catch (e) {
                console.error('Purge failed', e);
                alert('Purge failed: see console');
            }
        }

        async function banUser(targetUid, durationMs, reason) {
            try {
                const until = Date.now() + durationMs;
                await set(ref(database, `bans/${targetUid}`), { bannedUntil: until, reason });
                window.bannedUsers[targetUid] = { bannedUntil: until, reason };
                // Optionally remove recent messages from that user in this channel
                // fetch last 500 and remove those authored by target
                const msgsRef = ref(database, `chat/${currentChannel}/messages`);
                const q = query(msgsRef, orderByChild('timestamp'), limitToLast(500));
                const snap = await get(q);
                snap.forEach(s => {
                    const val = s.val();
                    if (val && (val.author === targetUid || val.author === (window.usersMap && window.usersMap[targetUid]))) {
                        remove(child(msgsRef, s.key));
                    }
                });
                alert(`Banned ${targetUid} for ${Math.round(durationMs/1000)}s`);
            } catch (e) {
                console.error('Ban failed', e);
                alert('Ban failed: see console');
            }
        }

        async function unbanUser(targetUid) {
            try {
                await remove(ref(database, `bans/${targetUid}`));
                delete window.bannedUsers[targetUid];
                alert(`Unbanned ${targetUid}`);
            } catch (e) {
                console.error('Unban failed', e);
                alert('Unban failed: see console');
            }
        }
        
        // Cleanup old messages to prevent memory issues with massive chat history
        function cleanupOldMessages() {
            const maxMessages = 200; // Keep max 200 messages in DOM (optimized for performance)
            const messageElements = chatMessages.querySelectorAll('.chat-message');
            if (messageElements.length > maxMessages) {
                const removeCount = messageElements.length - maxMessages;
                for (let i = 0; i < removeCount; i++) {
                    messageElements[i].remove();
                }
            }
        }
        
        // Create message element without adding to DOM (for batch operations)
        // Cache for user profiles
        window.usersMap = window.usersMap || {};

        // LRU cache for user profiles to keep memory bounded and manage listeners
        class LRUCache {
            constructor(limit = 200) {
                this.limit = limit;
                this.map = new Map(); // key => { value, lastAccess }
            }
            get(key) {
                if (!this.map.has(key)) return null;
                const v = this.map.get(key);
                // move to end
                this.map.delete(key);
                this.map.set(key, v);
                return v.value;
            }
            set(key, value) {
                if (this.map.has(key)) this.map.delete(key);
                this.map.set(key, { value, at: Date.now() });
                // evict
                while (this.map.size > this.limit) {
                    const first = this.map.keys().next().value;
                    this.map.delete(first);
                    // Remove listener for evicted user if present
                    if (_userListeners && _userListeners[first]) {
                        try {
                            off(ref(database, `users/${first}`), _userListeners[first]);
                        } catch (e) {
                            try { off(ref(database, `users/${first}`)); } catch (e2) {}
                        }
                        delete _userListeners[first];
                    }
                }
            }
        }

        window.userCache = window.userCache || new LRUCache(200);
        const _userListeners = window._userListeners || (window._userListeners = {});

        async function getUserProfile(uid) {
            if (!uid) return null;
            const cached = window.userCache.get(uid);
            if (cached) return cached;
            try {
                const userRef = ref(database, `users/${uid}`);
                const snap = await get(userRef);
                const data = snap.val();
                if (data) {
                    data.uid = uid;
                    window.userCache.set(uid, data);
                }
                // Attach a small `onValue` listener to keep profile fresh (but only for some users)
                if (!_userListeners[uid]) {
                    _userListeners[uid] = onValue(userRef, (s) => {
                        const d = s.val();
                        if (d) {
                            d.uid = uid;
                            window.userCache.set(uid, d);
                            // update author elements if any
                            try {
                                document.querySelectorAll(`.chat-message .chat-message-author[data-uid="${uid}"]`).forEach(el => {
                                    el.textContent = d.username || d.displayName || el.textContent;
                                });
                                document.querySelectorAll(`.chat-message .chat-message-avatar img`).forEach(img => {
                                    const parent = img.closest('.chat-message');
                                    if (parent && parent.querySelector(`.chat-message-author[data-uid=\"${uid}\"]`)) {
                                        img.src = d.photoURL || img.src;
                                    }
                                });
                            } catch (e) { /* ignore */ }
                        }
                    });
                }
                return data || null;
            } catch (e) {
                console.warn('Failed to load user profile', uid, e);
            }
            return null;
        }

        function createMessageElement(msg, isNew = false) {
            if (!msg || !msg.author) return null;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            // attach data-id for DOM removal or moderation
            if (msg.id) messageDiv.setAttribute('data-id', msg.id);
            if (msg.replyTo) messageDiv.classList.add('reply');
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'chat-message-avatar';
            // Set initial avatar content based on fallback
            const initial = (msg.author || (msg.authorDisplayName || '')).charAt(0).toUpperCase() || '?';
            avatar.textContent = initial;
            // If we have an authorId, fetch profile and update avatar/name
            if (msg.authorId) {
                getUserProfile(msg.authorId).then(profile => {
                    if (!profile) return;
                    // replace avatar with image if available
                    if (profile.photoURL) {
                        avatar.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = profile.photoURL;
                        img.alt = profile.username || profile.displayName || 'User';
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.borderRadius = '50%';
                        avatar.appendChild(img);
                    }
                });
            }
            
            // Content container
            const content = document.createElement('div');
            content.className = 'chat-message-content';
            
            // Reply info (if exists)
            if (msg.replyTo) {
                const replyInfo = document.createElement('div');
                replyInfo.className = 'chat-message-reply-info';
                replyInfo.textContent = `‚Ü≥ ${msg.replyTo.author}: ${msg.replyTo.text}`;
                content.appendChild(replyInfo);
            }
            
            // Header (author + time + actions)
            const header = document.createElement('div');
            header.className = 'chat-message-header';
            
            const author = document.createElement('span');
            author.className = 'chat-message-author';
            const initialName = msg.author || (msg.authorDisplayName || 'Anonymous');
            author.textContent = initialName;
            // If authorId present, fetch profile and update display name when available
            if (msg.authorId) {
                getUserProfile(msg.authorId).then(profile => {
                    if (!profile) return;
                    author.textContent = profile.username || profile.displayName || initialName;
                }).catch(() => {});
                author.setAttribute('data-uid', msg.authorId);
            }
            
            const time = document.createElement('span');
            time.className = 'chat-message-time';
            const timestamp = msg.timestamp ? new Date(msg.timestamp) : new Date();
            time.textContent = timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            // Reply button
            const replyBtn = document.createElement('span');
            replyBtn.className = 'message-action-btn';
            replyBtn.textContent = '‚Ü© Reply';
            replyBtn.onclick = () => setReply(msg);
            actions.appendChild(replyBtn);

            // Delete button - only show to the message author (client-side)
            const canDelete = (msg.author && (msg.author === userId)) || (typeof currentUser !== 'undefined' && currentUser && (msg.author === currentUser.uid || msg.author === currentUser.displayName || msg.author === currentUser.email));
            if (canDelete) {
                const delBtn = document.createElement('span');
                delBtn.className = 'message-action-btn';
                delBtn.style.background = 'rgba(220, 53, 69, 0.25)';
                delBtn.style.color = 'white';
                delBtn.textContent = 'üóë Delete';
                delBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (!msg.id) {
                        alert('Cannot delete this message (no id).');
                        return;
                    }
                    if (!confirm('Delete this message?')) return;
                    try {
                        await remove(child(ref(database, `chat/${currentChannel}/messages`), msg.id));
                        const el = document.querySelector(`.chat-message[data-id="${msg.id}"]`);
                        if (el) el.remove();
                    } catch (err) {
                        console.error('Failed to delete message', err);
                        alert('Failed to delete message. See console.');
                    }
                };
                actions.appendChild(delBtn);
            }
            
            header.append(author, time, actions);
            
            // Message text/content
            const text = document.createElement('div');
            text.className = 'chat-message-text';
            
            const isGif = msg.text && (msg.text.includes('giphy.com') || msg.text.includes('tenor.com'));
            if (isGif) {
                text.innerHTML = `<img src="${msg.text}" style="max-width:250px;max-height:250px;border-radius:8px;margin-top:4px" loading="lazy" decoding="async" alt="GIF">`;
            } else {
                // Sanitize and render text with mentions
                const sanitizedText = (msg.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                text.innerHTML = sanitizedText.replace(/@(\w+)/g, '<span class="chat-mention">@$1</span>');
            }
            
            content.append(header, text);
            messageDiv.append(avatar, content);
            
            return messageDiv;
        }
        
        function displayMessage(message, isNew = false) {
            // If the tab is not visible, buffer messages to render later
            if (typeof document !== 'undefined' && document.hidden) {
                window._chatMessageBuffer = window._chatMessageBuffer || [];
                window._chatMessageBuffer.push({ message, isNew });
                return;
            }
            if (!message || (!message.author && !message.authorId)) return;
            
            // Track active users for mentions
            if (!window.activeUsers) window.activeUsers = new Set();
            window.activeUsers.add(message.author);
            
            // Track new messages
            if (isNew && !hasScrolledToBottom && message.author !== userId) {
                newMessageCount++;
                showNewMessageCounter();
            }
            
            // Virtualization: update allMessages and render virtual window
            if (!message.id) return; // must have id for tracking
            const existingIndex = allMessages.findIndex(m => m.id === message.id);
            if (existingIndex !== -1) {
                allMessages[existingIndex] = message;
            } else {
                allMessages.push(message);
            }
            // If too many messages, cap to CHAT_MAX_HISTORY (evict older)
            if (allMessages.length > CHAT_MAX_HISTORY) {
                const over = allMessages.length - CHAT_MAX_HISTORY;
                allMessages.splice(0, over);
                // adjust virtual start
                virtualStart = Math.max(0, virtualStart - over);
            }
            // Optionally auto-scroll if currently at bottom
            const atBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 50;
            renderVirtualWindow();
            if (atBottom) scrollToBottom();
            return;

            const fragment = document.createDocumentFragment();
            
            // Add new message divider if needed
            if (isNew && !hasScrolledToBottom && newMessageCount === 1) {
                const divider = document.createElement('div');
                divider.className = 'new-messages-divider';
                divider.innerHTML = '<span>New Messages</span>';
                fragment.appendChild(divider);
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            if (message.replyTo) messageDiv.classList.add('reply');
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'chat-message-avatar';
            const initialAvatar = (message.author || (message.authorDisplayName || '')).charAt(0).toUpperCase() || '?';
            avatar.textContent = initialAvatar;
            if (message.authorId) {
                getUserProfile(message.authorId).then(profile => {
                    if (!profile) return;
                    if (profile.photoURL) {
                        avatar.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = profile.photoURL;
                        img.alt = profile.username || profile.displayName || 'User';
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.borderRadius = '50%';
                        avatar.appendChild(img);
                    }
                }).catch(() => {});
            }
            
            // Content container
            const content = document.createElement('div');
            content.className = 'chat-message-content';
            
            // Reply info (if exists)
            if (message.replyTo) {
                const replyInfo = document.createElement('div');
                replyInfo.className = 'chat-message-reply-info';
                replyInfo.textContent = `‚Ü≥ ${message.replyTo.author}: ${message.replyTo.text}`;
                content.appendChild(replyInfo);
            }
            
            // Header (author + time + actions)
            const header = document.createElement('div');
            header.className = 'chat-message-header';
            
            const author = document.createElement('span');
            author.className = 'chat-message-author';
            const initialName = message.author || (message.authorDisplayName || 'Anonymous');
            author.textContent = initialName;
            if (message.authorId) {
                getUserProfile(message.authorId).then(profile => {
                    if (!profile) return;
                    author.textContent = profile.username || profile.displayName || initialName;
                }).catch(() => {});
            }
            
            const time = document.createElement('span');
            time.className = 'chat-message-time';
            const timestamp = message.timestamp ? new Date(message.timestamp) : new Date();
            time.textContent = timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            actions.innerHTML = '<span class="message-action-btn">‚Ü© Reply</span>';
            actions.firstChild.onclick = () => setReply(message);
            
            header.append(author, time, actions);
            
            // Message text/content
            const text = document.createElement('div');
            text.className = 'chat-message-text';
            
            const isGif = message.text && (message.text.includes('giphy.com') || message.text.includes('tenor.com'));
            if (isGif) {
                text.innerHTML = `<img src="${message.text}" style="max-width:250px;max-height:250px;border-radius:8px;margin-top:4px" loading="lazy">`;
            } else {
                text.innerHTML = (message.text || '').replace(/@(\w+)/g, '<span class="chat-mention">@$1</span>');
            }
            
            content.append(header, text);
            messageDiv.append(avatar, content);
            fragment.appendChild(messageDiv);
            
            // Batch DOM update with requestAnimationFrame for performance
            requestAnimationFrame(() => {
                chatMessages.appendChild(fragment);
                
                // Cleanup old messages during idle time to prevent lag
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(() => cleanupOldMessages(), { timeout: 2000 });
                } else {
                    setTimeout(cleanupOldMessages, 100);
                }
                
                if (hasScrolledToBottom) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        // Flush buffered messages when tab becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                const buf = window._chatMessageBuffer || [];
                if (buf.length > 0) {
                    // Append in a single batch
                    const frag = document.createDocumentFragment();
                    buf.forEach(({ message, isNew }) => {
                        const md = document.createElement('div');
                        // use existing display routine to build element
                        const elem = createMessageElement(message, isNew);
                        if (elem) frag.appendChild(elem);
                    });
                    if (frag.childNodes.length > 0) {
                        chatMessages.appendChild(frag);
                        if (hasScrolledToBottom) chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    window._chatMessageBuffer = [];
                }
            }
        });

        // Infinite scroll: Load older messages when scrolling to top
        chatMessages.addEventListener('scroll', () => {
            const scrolledToTop = chatMessages.scrollTop < 100;
            
            if (scrolledToTop && !isLoadingOlderMessages && hasMoreMessages) {
                loadOlderMessages();
            }
            
            // Virtualized: compute virtual start based on scrollTop
            // Approximate index using avgHeight
            const avg = VIRTUAL_CONFIG.avgHeight;
            const newStart = Math.max(0, Math.floor(chatMessages.scrollTop / avg) - VIRTUAL_CONFIG.overscan);
            if (newStart !== virtualStart) {
                virtualStart = newStart;
                renderVirtualWindow();
            }
            // Track if user is at bottom for auto-scroll
            const atBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 50;
            hasScrolledToBottom = atBottom;
        });
        
        // Load older messages when scrolling up
        async function loadOlderMessages() {
            if (isLoadingOlderMessages || !hasMoreMessages || !oldestMessageTimestamp) return;
            
            isLoadingOlderMessages = true;
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.textContent = 'Loading older messages...';
            chatMessages.insertBefore(loadingIndicator, chatMessages.firstChild);
            
            const prevScrollHeight = chatMessages.scrollHeight;
            
            try {
                const olderMessagesRef = ref(database, `chat/${currentChannel}/messages`);
                // Respect CHAT_MAX_HISTORY cap ‚Äî only request enough to not exceed the total allowed
                const currentlyLoaded = chatMessages.querySelectorAll('.chat-message').length;
                const remainingAllowed = CHAT_MAX_HISTORY - currentlyLoaded;
                if (remainingAllowed <= 0) {
                    hasMoreMessages = false;
                    loadingIndicator.textContent = 'Reached history limit';
                    setTimeout(() => loadingIndicator.remove(), 1500);
                    isLoadingOlderMessages = false;
                    return;
                }
                const fetchLimit = Math.min(50, remainingAllowed);

                const olderQuery = query(
                    olderMessagesRef,
                    orderByChild('timestamp'),
                    endBefore(oldestMessageTimestamp),
                    limitToLast(fetchLimit)
                );
                
                const snapshot = await get(olderQuery);
                const messages = [];
                snapshot.forEach((childSnapshot) => {
                    messages.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                if (messages.length === 0) {
                    hasMoreMessages = false;
                    loadingIndicator.textContent = 'No more messages';
                    setTimeout(() => loadingIndicator.remove(), 2000);
                } else {
                    messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    oldestMessageTimestamp = messages[0].timestamp;
                    
                    // Prepend to allMessages, preserve virtualStart to keep scroll position
                    allMessages = messages.concat(allMessages);
                    oldestMessageTimestamp = messages[0].timestamp;
                    // Maintain scroll position by adjusting virtualStart
                    virtualStart += messages.length;
                    loadingIndicator.remove();
                    // Re-render virtual window
                    renderVirtualWindow();
                    
                    // Maintain scroll position
                    chatMessages.scrollTop = chatMessages.scrollHeight - prevScrollHeight;
                }
            } catch (error) {
                debug.error('Error loading older messages:', error);
                loadingIndicator.textContent = 'Failed to load messages';
                setTimeout(() => loadingIndicator.remove(), 2000);
            } finally {
                isLoadingOlderMessages = false;
            }
        }
        
        // Event listeners
        chatSendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // ==================== ADVANCED CHAT FEATURES ====================
        
        // Initialize emoji picker
        const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üòà','üëø','üëπ','üë∫','ü§°','üí©','üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ','ü§ñ','üéÉ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];
        const emojiGrid = document.getElementById('emojiGrid');
        emojis.forEach(emoji => {
            const item = document.createElement('div');
            item.className = 'emoji-item';
            item.textContent = emoji;
            item.onclick = () => insertEmoji(emoji);
            emojiGrid.appendChild(item);
        });
        
        window.toggleEmojiPicker = function() {
            if (!currentUser) { openAuthModal(); return; }
            const picker = document.getElementById('emojiPicker');
            const gifPicker = document.getElementById('gifPicker');
            picker.classList.toggle('show');
            gifPicker.classList.remove('show');
        }
        
        window.insertEmoji = function(emoji) {
            if (!currentUser) { openAuthModal(); return; }
            chatInput.value += emoji;
            chatInput.focus();
        }
        
        // GIF picker functionality
        let gifSearchTimeout;
        window.toggleGifPicker = function() {
            if (!currentUser) { openAuthModal(); return; }
            const picker = document.getElementById('gifPicker');
            const emojiPicker = document.getElementById('emojiPicker');
            picker.classList.toggle('show');
            emojiPicker.classList.remove('show');
            if (picker.classList.contains('show')) {
                searchGifs('happy'); // Default search
            }
        }
        
        document.getElementById('gifSearch').addEventListener('input', (e) => {
            clearTimeout(gifSearchTimeout);
            gifSearchTimeout = setTimeout(() => {
                searchGifs(e.target.value || 'happy');
            }, 500);
        });
        
        async function searchGifs(query) {
            try {
                // Using Giphy API instead (more reliable)
                const response = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=sXpGFDGZs0Dv1mmNFvYaGUvYwKX0PWIh&q=${encodeURIComponent(query)}&limit=12&rating=g`);
                const data = await response.json();
                const gifGrid = document.getElementById('gifGrid');
                gifGrid.innerHTML = '';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(gif => {
                        const item = document.createElement('div');
                        item.className = 'gif-item';
                        const img = document.createElement('img');
                        img.src = gif.images.fixed_height_small.url;
                        img.onclick = () => insertGif(gif.images.original.url);
                        item.appendChild(img);
                        gifGrid.appendChild(item);
                    });
                } else {
                    gifGrid.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No GIFs found</p>';
                }
            } catch (error) {
                console.error('GIF search error:', error);
                document.getElementById('gifGrid').innerHTML = '<p style="color: var(--text-muted); text-align: center;">Error loading GIFs</p>';
            }
        }
        
        function insertGif(url) {
            // Send GIF URL as message
            if (!currentUser) {
                alert('Please sign in to chat.');
                openAuthModal();
                return;
            }
            const cooldownCheck = canSendMessage();
            if (!cooldownCheck.allowed) {
                alert(`Please wait ${cooldownCheck.secondsLeft} seconds before sending another message in this channel.`);
                return;
            }
            
            push(chatMessagesRef, {
                author: userId,
                authorId: currentUser.uid,
                authorDisplayName: currentUser.displayName || currentUser.email,
                text: url,
                timestamp: serverTimestamp()
            });
            
            lastMessageTime[currentChannel] = Date.now();
            document.getElementById('gifPicker').classList.remove('show');
        }
        
        // Reply functionality
        function setReply(message) {
            replyingTo = message;
            const preview = document.getElementById('replyPreview');
            const previewText = document.getElementById('replyPreviewText');
            previewText.textContent = `Replying to ${message.author}: ${message.text.substring(0, 50)}${message.text.length > 50 ? '...' : ''}`;
            preview.classList.add('show');
            chatInput.focus();
        }
        
        window.cancelReply = function() {
            replyingTo = null;
            document.getElementById('replyPreview').classList.remove('show');
        }
        
        // Mention autocomplete system
        let activeUsers = new Set();
        let selectedMentionIndex = 0;
        
        // Track active users from messages
        function updateActiveUsers(message) {
            if (message && message.author) {
                activeUsers.add(message.author);
            }
        }

        // Performance: Long Task observer to log UI blocking events
        if (typeof PerformanceObserver !== 'undefined') {
            try {
                const perfObserver = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        console.warn('Long Task:', entry);
                    });
                });
                perfObserver.observe({ entryTypes: ['longtask'] });
            } catch (e) { /* ignore if not supported */ }
        }

        // Register service worker for caching static assets and thumbnails
        if ('serviceWorker' in navigator) {
            try {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered:', reg.scope))
                    .catch(err => console.warn('Service Worker registration failed:', err));
            } catch (e) { console.warn('Service Worker registration failed', e); }
        }
        
        chatInput.addEventListener('input', (e) => {
            const text = e.target.value;
            const lastWord = text.split(' ').pop();
            const mentionAutocomplete = document.getElementById('mentionAutocomplete');
            
            if (lastWord.startsWith('@') && lastWord.length > 1) {
                const searchTerm = lastWord.substring(1).toLowerCase();
                const matches = Array.from(activeUsers).filter(user => 
                    user.toLowerCase().includes(searchTerm)
                );
                
                if (matches.length > 0) {
                    mentionAutocomplete.innerHTML = '';
                    matches.forEach((user, index) => {
                        const item = document.createElement('div');
                        item.className = 'mention-item';
                        if (index === selectedMentionIndex) item.classList.add('selected');
                        item.textContent = '@' + user;
                        item.onclick = () => completeMention(user);
                        mentionAutocomplete.appendChild(item);
                    });
                    mentionAutocomplete.classList.add('show');
                    selectedMentionIndex = 0;
                } else {
                    mentionAutocomplete.classList.remove('show');
                }
            } else {
                mentionAutocomplete.classList.remove('show');
            }
        });
        
        chatInput.addEventListener('keydown', (e) => {
            const mentionAutocomplete = document.getElementById('mentionAutocomplete');
            if (mentionAutocomplete.classList.contains('show')) {
                const items = mentionAutocomplete.querySelectorAll('.mention-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedMentionIndex = (selectedMentionIndex + 1) % items.length;
                    items.forEach((item, i) => item.classList.toggle('selected', i === selectedMentionIndex));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedMentionIndex = (selectedMentionIndex - 1 + items.length) % items.length;
                    items.forEach((item, i) => item.classList.toggle('selected', i === selectedMentionIndex));
                } else if (e.key === 'Tab' || e.key === 'Enter') {
                    if (items[selectedMentionIndex]) {
                        e.preventDefault();
                        const username = items[selectedMentionIndex].textContent.substring(1);
                        completeMention(username);
                    }
                }
            }
        });
        
        function completeMention(username) {
            const text = chatInput.value;
            const words = text.split(' ');
            words[words.length - 1] = '@' + username;
            chatInput.value = words.join(' ') + ' ';
            document.getElementById('mentionAutocomplete').classList.remove('show');
            chatInput.focus();
        }

        // ==================== CHAT CHANNEL SYSTEM ====================
        
        let currentChannel = 'general';
        let chatMessagesListener = null;
        let lastMessageTime = {};
        // Chat history limits
        const CHAT_MAX_HISTORY = 500; // maximum messages to load into client (reduced for performance)
        const INITIAL_LOAD = Math.min(100, CHAT_MAX_HISTORY); // initial messages to load (smaller initial batch)

        // Moderation state
        window.moderators = new Set();
        window.bannedUsers = {}; // { userId: { bannedUntil: timestamp, reason } }
        // Simple spam tracker: map userId -> array of recent message timestamps
        const spamTracker = {};
        const SPAM_WINDOW_MS = 8000; // 8 seconds
        const SPAM_THRESHOLD = 5; // more than 5 messages in window -> spam
        // Offensive words (simple list). Improve as needed or move to server-side.
        const offensiveWords = [ 'badword1', 'badword2', 'fuck', 'shit', 'bitch' ];
        const offensiveRegex = new RegExp('\\b(' + offensiveWords.join('|') + ')\\b', 'i');
        const channelCooldowns = {
            'general': 0,
            'builders': 60000,  // 1 minute
            'help': 60000       // 1 minute
        };
        // Ensure chat initializes only after DOM and Firebase app are ready.
        // We don't require an authenticated user to view chat history ‚Äî initialize regardless.
        function initializeChatAfterAuth() {
            // Ensure Firebase app/DB are initialized
            if (!window.firebaseApp && !window.firebaseDb) return;

            // Resolve chatMessages element if not already available
            if (!chatMessages) chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            if (window.__chatInitialized) return;
            window.__chatInitialized = true;

            // Load the currently selected channel (default 'general')
            switchChatChannel(currentChannel);
        }

        // Initialize once DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeChatAfterAuth();
            // Initialize chat UI disabled until user signs in
            updateChatUIForAuth(currentUser);
        });

        // Also attempt initialization when auth state changes (useful if Firebase initializes later)
        if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChanged === 'function') {
            onAuthStateChanged(auth, (user) => {
                initializeChatAfterAuth();
            });
        }
        
        window.switchChatChannel = function(channel) {
            // Ensure chatMessages element is available
            if (!chatMessages) chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // If we're already on the requested channel and a listener exists, nothing to do.
            // If no listener exists (initial load), continue to subscribe.
            if (currentChannel === channel && chatMessagesListener) return;
            
            console.log('Switching to channel:', channel);
            
            // Update UI
            document.querySelectorAll('.chat-channel-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.channel === channel);
            });
            
            // Unsubscribe from old channel
            if (chatMessagesListener) {
                off(chatMessagesRef);
                chatMessagesListener = null;
            }
            
            // Update current channel
            currentChannel = channel;
            
            // Clear messages
            chatMessages.innerHTML = '';
            // Recycle visible nodes into pool
            for (const k in visibleNodes) {
                const n = visibleNodes[k];
                if (n && n.parentNode) n.parentNode.removeChild(n);
                if (nodePool.length < POOL_MAX) nodePool.push(n);
            }
            visibleNodes = {};
            
            // Update input placeholder with cooldown info
            updateChatInputPlaceholder();
            
            // Subscribe to new channel
            chatMessagesRef = ref(database, `chat/${channel}/messages`);
            // Load an initial batch (bounded by CHAT_MAX_HISTORY)
            const messagesQuery = query(chatMessagesRef, limitToLast(INITIAL_LOAD));
            
            let isInitialLoad = true;
            chatMessagesListener = onValue(messagesQuery, (snapshot) => {
                if (isInitialLoad) {
                    chatMessages.innerHTML = '';
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    
                    // Track oldest message for infinite scroll
                    if (messages.length > 0) {
                        oldestMessageTimestamp = messages[0].timestamp;
                        hasMoreMessages = true;
                    }
                    
                    // Use virtualized rendering - populate allMessages and render window
                    allMessages = messages.slice();
                    // Cap to history
                    if (allMessages.length > CHAT_MAX_HISTORY) {
                        const over = allMessages.length - CHAT_MAX_HISTORY;
                        allMessages.splice(0, over);
                    }
                    // Set virtual start to show the bottom of list
                    virtualStart = Math.max(0, allMessages.length - computeWindowSize());
                    renderVirtualWindow();
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    resetNewMessageCounter();
                    isInitialLoad = false;
                } else {
                    // New message arrived (snapshot contains latest batch) ‚Äî process newest only
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    if (messages.length === 0) return;
                    const sortedMessages = messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    const newestMessage = sortedMessages[sortedMessages.length - 1];

                    // Auto-moderation: check offensive content
                    const text = (newestMessage.text || '').toString();
                    if (offensiveRegex.test(text)) {
                        // remove message and timeout user
                        remove(child(ref(database, `chat/${currentChannel}/messages`), newestMessage.id));
                        applyTimeoutToUser(newestMessage.author, 5 * 60 * 1000, 'Auto-timeout: offensive language');
                        console.warn('Removed offensive message from', newestMessage.author);
                        return;
                    }

                    // Check if author is banned
                    if (isUserBanned(newestMessage.author)) {
                        // remove message
                        remove(child(ref(database, `chat/${currentChannel}/messages`), newestMessage.id));
                        return;
                    }

                    // Spam detection based on message author timestamps
                    try {
                        trackSpam(newestMessage.author);
                    } catch (e) {
                        console.warn('Spam tracker error', e);
                    }

                    // Display message
                    displayMessage(newestMessage, true);
                    // Cleanup if exceeding history
                    cleanupOldMessages();
                }
            });
        }
        
        function updateChatInputPlaceholder() {
            const cooldown = channelCooldowns[currentChannel];
            if (cooldown > 0) {
                chatInput.placeholder = `Type a message... (1 min cooldown)`;
            } else {
                chatInput.placeholder = 'Type a message...';
            }
        }
        
        function canSendMessage() {
            const cooldown = channelCooldowns[currentChannel];
            if (cooldown === 0) return { allowed: true };
            
            const lastTime = lastMessageTime[currentChannel] || 0;
            const now = Date.now();
            const timePassed = now - lastTime;
            
            if (timePassed < cooldown) {
                const secondsLeft = Math.ceil((cooldown - timePassed) / 1000);
                return { allowed: false, secondsLeft };
            }
            
            return { allowed: true };
        }

        // (Initialization handled by initializeChatAfterAuth)

        // ==================== AUTHENTICATION SYSTEM ====================
        
        const usersRef = ref(database, 'users');
        let usernameCheckTimeout = null;

        // Validate username input - only alphanumeric and underscore
        window.validateUsernameInput = function(input) {
            // Remove spaces and invalid characters in real-time
            input.value = input.value.replace(/\s+/g, '').replace(/[^a-zA-Z0-9_-]/g, '');
        }

        // Check if username is available
        async function checkUsernameAvailability(username) {
            if (!username || username.length < 3) return false;
            // Validate format
            if (!/^[a-zA-Z0-9_]+$/.test(username)) return false;
            const snapshot = await get(child(ref(database), `usernames/${username.toLowerCase()}`));
            return !snapshot.exists();
        }

        // Username input with debounced checking
        document.getElementById('signupUsername')?.addEventListener('input', async (e) => {
            clearTimeout(usernameCheckTimeout);
            const username = e.target.value.trim();
            const checkEl = document.getElementById('usernameCheck');
            
            if (username.length < 3) {
                checkEl.textContent = '';
                return;
            }
            
            checkEl.textContent = 'Checking...';
            checkEl.className = 'username-check';
            
            usernameCheckTimeout = setTimeout(async () => {
                const available = await checkUsernameAvailability(username);
                if (available) {
                    checkEl.textContent = '‚úì Username available';
                    checkEl.className = 'username-check available';
                } else {
                    checkEl.textContent = '‚úó Username taken';
                    checkEl.className = 'username-check taken';
                }
            }, 500);
        });

        // Profile picture preview
        document.getElementById('signupProfilePic')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('signupProfilePreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('editProfilePic')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('editProfilePreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle Sign Up
        window.handleSignup = async function() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const profilePicFile = document.getElementById('signupProfilePic').files[0];
            
            // Clear previous errors
            document.querySelectorAll('.auth-error-msg').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.auth-form-input').forEach(el => el.classList.remove('error'));
            
            // Validation
            let hasError = false;
            
            // Validate and clean username (remove spaces automatically)
            const cleanUsername = validateUsername(username);
            
            if (cleanUsername.length < 3) {
                showError('signupUsername', 'signupUsernameError', 'Username must be at least 3 characters (spaces not allowed)');
                hasError = true;
            }
            
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showError('signupEmail', 'signupEmailError', 'Please enter a valid email');
                hasError = true;
            }
            
            if (password.length < 6) {
                showError('signupPassword', 'signupPasswordError', 'Password must be at least 6 characters');
                hasError = true;
            }
            
            if (password !== confirmPassword) {
                showError('signupConfirmPassword', 'signupConfirmError', 'Passwords do not match');
                hasError = true;
            }
            
            if (hasError) return;
            
            // Check username availability
            const usernameAvailable = await checkUsernameAvailability(username);
            if (!usernameAvailable) {
                showError('signupUsername', 'signupUsernameError', 'Username is already taken');
                return;
            }
            
            const btn = document.getElementById('signupSubmitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            
            try {
                // Create user account
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                let photoURL = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=FF1744&color=fff&size=200`;
                
                // Upload profile picture if provided
                if (profilePicFile) {
                    const profileRef = storageRef(storage, `profiles/${user.uid}/${Date.now()}_${profilePicFile.name}`);
                    await uploadBytes(profileRef, profilePicFile);
                    photoURL = await getDownloadURL(profileRef);
                }
                
                // Update Firebase Auth profile with cleaned username
                const cleanUsername = validateUsername(username);
                await updateProfile(user, {
                    displayName: cleanUsername,
                    photoURL: photoURL
                });
                
                // Store user data in Realtime Database with cleaned username
                await set(ref(database, `users/${user.uid}`), {
                    username: cleanUsername,
                    email: email,
                    photoURL: photoURL,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                });
                
                // Reserve username
                await set(ref(database, `usernames/${cleanUsername.toLowerCase()}`), user.uid);
                
                closeAuthModal();
                alert('Account created successfully! Welcome to Crumbl Crafts! üéâ');
                
            } catch (error) {
                console.error('Sign up error:', error);
                let errorMsg = 'Failed to create account';
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = 'Email is already registered';
                    showError('signupEmail', 'signupEmailError', errorMsg);
                } else {
                    alert(errorMsg + ': ' + error.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
            }
        }

        // Handle Anonymous Sign In
        window.handleAnonymousSignIn = async function() {
            try {
                const userCredential = await signInAnonymously(auth);
                console.log('Anonymous user signed in:', userCredential.user.uid);
                
                // Generate random guest username
                let guestUsername = 'Guest_' + Math.random().toString(36).substr(2, 6);
                guestUsername = validateUsername(guestUsername);
                
                // Store guest user info
                await set(ref(database, `users/${userCredential.user.uid}`), {
                    username: guestUsername,
                    isAnonymous: true,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                });
                
                closeAuthModal();
                alert(`Welcome ${guestUsername}! You're browsing as a guest. Sign up to save your data.`);
                
            } catch (error) {
                console.error('Anonymous sign in error:', error);
                alert('Failed to sign in anonymously: ' + error.message);
            }
        }

        // Handle Google Sign In
        window.handleGoogleSignIn = async function() {
            const provider = new GoogleAuthProvider();
            
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Check if user exists in database
                const userSnapshot = await get(ref(database, `users/${user.uid}`));
                
                if (!userSnapshot.exists()) {
                    // New Google user - create profile with validated username
                    let username = user.displayName || user.email.split('@')[0];
                    username = validateUsername(username);
                    await set(ref(database, `users/${user.uid}`), {
                        username: username,
                        email: user.email,
                        photoURL: user.photoURL,
                        provider: 'google',
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    });
                } else {
                    // Update last login
                    await update(ref(database, `users/${user.uid}`), {
                        lastLogin: serverTimestamp()
                    });
                }
                
                closeAuthModal();
                
            } catch (error) {
                console.error('Google sign in error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    // User closed popup, no error needed
                } else if (error.code === 'auth/popup-blocked') {
                    alert('Pop-up blocked. Please allow pop-ups for this site.');
                } else {
                    alert('Failed to sign in with Google: ' + error.message);
                }
            }
        }

        // Handle Email Link Sign In
        window.handleEmailLinkSignIn = async function() {
            const email = prompt('Enter your email address to receive a sign-in link:');
            
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            const actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true
            };
            
            try {
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                
                // Save email to localStorage for sign-in completion
                window.localStorage.setItem('emailForSignIn', email);
                
                alert('Sign-in link sent! Check your email and click the link to sign in.');
                
            } catch (error) {
                console.error('Email link sign in error:', error);
                alert('Failed to send sign-in link: ' + error.message);
            }
        }

        // Check if URL is from email link sign in
        if (isSignInWithEmailLink(auth, window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) {
                email = prompt('Please provide your email for confirmation:');
            }
            
            if (email) {
                signInWithEmailLink(auth, email, window.location.href)
                    .then(async (result) => {
                        window.localStorage.removeItem('emailForSignIn');
                        
                        // Check if user exists
                        const userSnapshot = await get(ref(database, `users/${result.user.uid}`));
                        
                        if (!userSnapshot.exists()) {
                            // New user via email link
                            await set(ref(database, `users/${result.user.uid}`), {
                                username: email.split('@')[0],
                                email: email,
                                provider: 'email-link',
                                createdAt: serverTimestamp(),
                                lastLogin: serverTimestamp()
                            });
                        } else {
                            await update(ref(database, `users/${result.user.uid}`), {
                                lastLogin: serverTimestamp()
                            });
                        }
                        
                        alert('Successfully signed in!');
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                    })
                    .catch((error) => {
                        console.error('Email link sign in completion error:', error);
                        alert('Failed to complete sign in: ' + error.message);
                    });
            }
        }

        // Handle Sign In
        window.handleSignIn = async function() {
            const email = document.getElementById('signinEmail').value.trim();
            const password = document.getElementById('signinPassword').value;
            
            document.querySelectorAll('.auth-error-msg').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.auth-form-input').forEach(el => el.classList.remove('error'));
            
            let hasError = false;
            
            if (!email) {
                showError('signinEmail', 'signinEmailError', 'Email is required');
                hasError = true;
            }
            
            if (!password) {
                showError('signinPassword', 'signinPasswordError', 'Password is required');
                hasError = true;
            }
            
            if (hasError) return;
            
            const btn = document.getElementById('signinSubmitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                
                // Update last login
                if (auth.currentUser) {
                    await update(ref(database, `users/${auth.currentUser.uid}`), {
                        lastLogin: serverTimestamp()
                    });
                }
                
                closeAuthModal();
                
            } catch (error) {
                console.error('Sign in error:', error);
                let errorMsg = 'Invalid email or password';
                if (error.code === 'auth/user-not-found') {
                    errorMsg = 'No account found with this email';
                } else if (error.code === 'auth/wrong-password') {
                    errorMsg = 'Incorrect password';
                }
                showError('signinPassword', 'signinPasswordError', errorMsg);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }
        }

        // Handle Password Reset
        window.handlePasswordReset = async function() {
            const email = document.getElementById('resetEmail').value.trim();
            
            document.querySelectorAll('.auth-error-msg').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.auth-form-input').forEach(el => el.classList.remove('error'));
            
            if (!email) {
                showError('resetEmail', 'resetEmailError', 'Email is required');
                return;
            }
            
            const btn = document.getElementById('resetSubmitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            try {
                await sendPasswordResetEmail(auth, email);
                alert('Password reset link sent! Check your email.');
                showSignIn();
            } catch (error) {
                console.error('Password reset error:', error);
                showError('resetEmail', 'resetEmailError', 'Failed to send reset link');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-envelope"></i> Send Reset Link';
            }
        }

        // Handle Profile Update
        window.handleProfileUpdate = async function() {
            const newUsername = document.getElementById('editUsername').value.trim();
            const profilePicFile = document.getElementById('editProfilePic').files[0];
            
            if (!currentUser) return;
            
            document.querySelectorAll('.auth-error-msg').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.auth-form-input').forEach(el => el.classList.remove('error'));
            
            const btn = document.getElementById('profileSaveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                let updates = {};
                let authUpdates = {};
                
                // Handle username change
                if (newUsername && newUsername !== currentUser.displayName) {
                    if (newUsername.length < 3) {
                        showError('editUsername', 'editUsernameError', 'Username must be at least 3 characters');
                        return;
                    }
                    
                    if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
                        showError('editUsername', 'editUsernameError', 'Username can only contain letters, numbers, and underscores');
                        return;
                    }
                    
                    const available = await checkUsernameAvailability(newUsername);
                    if (!available) {
                        showError('editUsername', 'editUsernameError', 'Username is already taken');
                        return;
                    }
                    
                    // Remove old username reservation
                    await set(ref(database, `usernames/${currentUser.displayName.toLowerCase()}`), null);
                    // Reserve new username
                    await set(ref(database, `usernames/${newUsername.toLowerCase()}`), currentUser.uid);
                    
                    updates.username = newUsername;
                    authUpdates.displayName = newUsername;
                }
                
                // Handle profile picture change
                if (profilePicFile) {
                    const profileRef = storageRef(storage, `profiles/${currentUser.uid}/${Date.now()}_${profilePicFile.name}`);
                    await uploadBytes(profileRef, profilePicFile);
                    const photoURL = await getDownloadURL(profileRef);
                    
                    updates.photoURL = photoURL;
                    authUpdates.photoURL = photoURL;
                }
                
                // Update Firebase Auth profile
                if (Object.keys(authUpdates).length > 0) {
                    await updateProfile(currentUser, authUpdates);
                }
                
                // Update database
                if (Object.keys(updates).length > 0) {
                    await update(ref(database, `users/${currentUser.uid}`), updates);
                }
                
                closeAuthModal();
                alert('Profile updated successfully!');
                
                // Refresh UI
                updateUserUI(currentUser);
                
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Failed to update profile: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }

        // Handle Sign Out
        window.handleSignOut = async function() {
            try {
                await signOut(auth);
                closeAuthModal();
                alert('Signed out successfully');
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out');
            }
        }

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // Update chat to use real user
                const userData = (await get(ref(database, `users/${user.uid}`))).val();
                if (userData) {
                    userId = userData.username || user.displayName || user.email;
                    localStorage.setItem('chatUserId', userId);
                }
                
                // Load moderators list and bans from DB
                try {
                    const modsSnap = await get(ref(database, 'moderators'));
                    const mods = modsSnap.val() || {};
                    window.moderators = new Set(Object.keys(mods).filter(k => mods[k]));
                } catch (e) {
                    console.warn('Failed to load moderators:', e);
                }

                try {
                    const bansSnap = await get(ref(database, 'bans'));
                    window.bannedUsers = bansSnap.val() || {};
                } catch (e) {
                    console.warn('Failed to load bans:', e);
                }

                updateUserUI(user);
            } else {
                currentUser = null;
                updateUserUI(null);
            }
        });

        // Update UI based on auth state
        function updateUserUI(user) {
            const authBtn = document.getElementById('authButton');
            const userProfile = document.getElementById('userProfile');
            
            if (user) {
                authBtn.style.display = 'none';
                userProfile.style.display = 'flex';
                document.getElementById('userAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=FF1744&color=fff&size=80`;
                document.getElementById('userName').textContent = user.displayName || 'User';
                
                // Make profile clickable
                userProfile.onclick = () => {
                    showProfileEdit();
                };
            } else {
                authBtn.style.display = 'flex';
                userProfile.style.display = 'none';
            }
            // Update chat input enabling/disabling based on sign-in
            updateChatUIForAuth(user);
        }

        // Update chat input/button state - force sign-in to send messages
        function updateChatUIForAuth(user) {
            const chatInputEl = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const emojiBtn = document.querySelector('.chat-action-btn[aria-label="Add emoji"]');
            const gifBtn = document.querySelector('.chat-action-btn[aria-label="Add GIF"]');
            if (!chatInputEl) return;
            if (user) {
                chatInputEl.disabled = false;
                chatInputEl.placeholder = 'Type a message...';
                if (chatSendBtn) chatSendBtn.disabled = false;
                if (emojiBtn) emojiBtn.disabled = false;
                if (gifBtn) gifBtn.disabled = false;
            } else {
                chatInputEl.disabled = true;
                chatInputEl.placeholder = 'Please sign in to chat.';
                if (chatSendBtn) chatSendBtn.disabled = true;
                if (emojiBtn) emojiBtn.disabled = true;
                if (gifBtn) gifBtn.disabled = true;
            }
        }

        // Modal control functions
        function openAuthModal() {
            document.getElementById('authModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        window.closeAuthModal = function() {
            document.getElementById('authModal').classList.remove('show');
            document.body.style.overflow = '';
            
            // Clear all forms
            document.querySelectorAll('.auth-form-input').forEach(input => {
                input.value = '';
                input.classList.remove('error');
            });
            document.querySelectorAll('.auth-error-msg').forEach(el => el.classList.remove('show'));
        }

        window.showSignUp = function() {
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('signinForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('profileEditForm').style.display = 'none';
            openAuthModal();
        }

        window.showSignIn = function() {
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('signinForm').style.display = 'block';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('profileEditForm').style.display = 'none';
            openAuthModal();
        }

        window.showForgotPassword = function() {
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('signinForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
            document.getElementById('profileEditForm').style.display = 'none';
        }

        function showProfileEdit() {
            if (!currentUser) return;
            
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('signinForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('profileEditForm').style.display = 'block';
            
            // Pre-fill current values
            document.getElementById('editProfilePreview').src = currentUser.photoURL || '';
            document.getElementById('editUsername').placeholder = currentUser.displayName || 'Enter new username';
            
            openAuthModal();
        }

        function showError(inputId, errorId, message) {
            const input = document.getElementById(inputId);
            const error = document.getElementById(errorId);
            
            if (input) input.classList.add('error');
            if (error) {
                error.textContent = message;
                error.classList.add('show');
            }
        }

        // Username check for profile edit
        document.getElementById('editUsername')?.addEventListener('input', async (e) => {
            clearTimeout(usernameCheckTimeout);
            const username = e.target.value.trim();
            const checkEl = document.getElementById('editUsernameCheck');
            
            if (!username || username === currentUser.displayName) {
                checkEl.textContent = '';
                return;
            }
            
            if (username.length < 3) {
                checkEl.textContent = '';
                return;
            }
            
            checkEl.textContent = 'Checking...';
            checkEl.className = 'username-check';
            
            usernameCheckTimeout = setTimeout(async () => {
                const available = await checkUsernameAvailability(username);
                if (available) {
                    checkEl.textContent = '‚úì Username available';
                    checkEl.className = 'username-check available';
                } else {
                    checkEl.textContent = '‚úó Username taken';
                    checkEl.className = 'username-check taken';
                }
            }, 500);
        });

        // ==================== END AUTHENTICATION SYSTEM ====================
    </script>

    <script>
        // Dynamic Ad System - Global State
        let adAutoAdvanceInterval = null;
        let currentAdIndex = 0;
        let totalAds = 0;
        let adsDataGlobal = [];
        let videoCompletionTimeout = null;

        // Load and Initialize Ads from GitHub
        async function loadPremiumAds() {
            const adSlidesContainer = document.getElementById('adSlidesContainer');
            const adDotsWrapper = document.getElementById('adDotsWrapper');
            const adSection = document.getElementById('adSection');
            const adDotsContainer = document.getElementById('adDotsContainer');
            const adNavPrev = document.getElementById('adNavPrev');
            const adNavNext = document.getElementById('adNavNext');
            
            try {
                // Try GitHub first, fallback to local
                let adsData;
                try {
                    const response = await fetch('https://raw.githubusercontent.com/crumbl-crafts/crumbl_crafts/main/ads.json');
                    adsData = await response.json();
                } catch (githubError) {
                    console.log('Loading ads from local file...');
                    const localResponse = await fetch('ads.json');
                    adsData = await localResponse.json();
                }
                
                const ads = adsData.ads || [];
                totalAds = ads.length;
                adsDataGlobal = ads;
                
                // No ads, hide section completely
                if (totalAds === 0) {
                    adSection.style.display = 'none';
                    return;
                }
                
                // Show section
                adSection.style.display = 'block';
                
                // Generate ad slides
                adSlidesContainer.innerHTML = '';
                ads.forEach((ad, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'premium-ad-slide' + (index === 0 ? ' active' : '');
                    slide.style.cssText = `position: absolute; width: 100%; height: 100%; opacity: ${index === 0 ? 1 : 0}; transform: translate3d(${index === 0 ? 0 : 100}%, 0, 0); transition: opacity 0.6s ease, transform 0.6s ease; will-change: opacity, transform; z-index: 1;`;
                    
                    // Detect file type from URL
                    const url = ad.url.toLowerCase();
                    const isVideo = url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.ogg');
                    const isGif = url.endsWith('.gif');
                    
                    let mediaElement;
                    
                    if (isVideo) {
                        // Create video element
                        mediaElement = document.createElement('video');
                        mediaElement.src = ad.url;
                        mediaElement.autoplay = index === 0;
                        mediaElement.loop = totalAds === 1; // Loop if single ad
                        mediaElement.muted = true;
                        mediaElement.playsInline = true;
                        mediaElement.setAttribute('data-ad-index', index);
                        mediaElement.style.cssText = 'width: 100%; height: 100%; object-fit: contain; transform: translateZ(0);';
                        
                        // Advance to next ad when video ends (only if multiple ads)
                        if (totalAds > 1) {
                            mediaElement.addEventListener('ended', function() {
                                if (this.closest('.premium-ad-slide').classList.contains('active')) {
                                    navigatePremiumAd(1);
                                }
                            });
                        }
                        
                        // Handle video load errors
                        mediaElement.onerror = function() {
                            const fallbackColors = [
                                ['rgba(255,23,68,0.2)', 'rgba(41,121,255,0.2)', '#FF1744', 'fa-video', 'üé¨ VIDEO AD HERE'],
                                ['rgba(41,121,255,0.2)', 'rgba(0,230,118,0.2)', '#2979FF', 'fa-film', 'üé• YOUR VIDEO'],
                                ['rgba(0,230,118,0.2)', 'rgba(255,23,68,0.2)', '#00E676', 'fa-play-circle', '‚ñ∂Ô∏è PLAY AD']
                            ];
                            const colors = fallbackColors[index % fallbackColors.length];
                            this.parentElement.innerHTML = `<div style="padding:40px;text-align:center;background:linear-gradient(135deg, ${colors[0]}, ${colors[1]});height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;"><i class="fas ${colors[3]} fa-3x" style="color:${colors[2]};text-shadow: 3px 3px 0 rgba(0,0,0,0.8);margin-bottom:12px;"></i><h3 style="font-weight:900;font-size:1.3rem;color:#fff;text-shadow: 3px 3px 0 rgba(0,0,0,0.8);letter-spacing:2px;">${colors[4]}</h3></div>`;
                        };
                    } else {
                        // Create image element (works for both JPG/PNG and GIF)
                        mediaElement = document.createElement('img');
                        mediaElement.src = ad.url;
                        mediaElement.alt = ad.alt || `Premium Advertisement ${index + 1}`;
                        mediaElement.loading = index === 0 ? 'eager' : 'lazy';
                        mediaElement.style.cssText = 'width: 100%; height: 100%; object-fit: contain; image-rendering: auto; transform: translateZ(0);';
                        
                        // Handle image load errors
                        mediaElement.onerror = function() {
                            const fallbackColors = [
                                ['rgba(255,23,68,0.2)', 'rgba(41,121,255,0.2)', '#FF1744', 'fa-ad', 'üé® ADVERTISE HERE'],
                                ['rgba(41,121,255,0.2)', 'rgba(0,230,118,0.2)', '#2979FF', 'fa-image', 'üíº YOUR AD HERE'],
                                ['rgba(0,230,118,0.2)', 'rgba(255,23,68,0.2)', '#00E676', 'fa-bullhorn', '‚≠ê BE FEATURED']
                            ];
                            const colors = fallbackColors[index % fallbackColors.length];
                            this.parentElement.innerHTML = `<div style="padding:40px;text-align:center;background:linear-gradient(135deg, ${colors[0]}, ${colors[1]});height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;"><i class="fas ${colors[3]} fa-3x" style="color:${colors[2]};text-shadow: 3px 3px 0 rgba(0,0,0,0.8);margin-bottom:12px;"></i><h3 style="font-weight:900;font-size:1.3rem;color:#fff;text-shadow: 3px 3px 0 rgba(0,0,0,0.8);letter-spacing:2px;">${colors[4]}</h3></div>`;
                        };
                    }
                    
                    slide.appendChild(mediaElement);
                    slide.setAttribute('data-video', isVideo);
                    slide.setAttribute('data-ad-link', ad.link || '');
                    slide.setAttribute('data-button-text', ad.buttonText || 'Learn More');
                    
                    adSlidesContainer.appendChild(slide);
                });
                
                // Populate buttons for first ad and show container
                const adButtonsContainer = document.getElementById('adButtonsContainer');
                updateAdButtons(0);
                adButtonsContainer.style.display = 'flex';
                
                // Only show controls if multiple ads
                if (totalAds > 1) {
                    // Show navigation arrows
                    adNavPrev.style.display = 'flex';
                    adNavNext.style.display = 'flex';
                    
                    // Generate dots
                    adDotsWrapper.innerHTML = '';
                    for (let i = 0; i < totalAds && i < 7; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'premium-ad-dot' + (i === 0 ? ' active' : '');
                        dot.setAttribute('data-index', i);
                        dot.style.cssText = i === 0 
                            ? 'width: 12px; height: 12px; border-radius: 50%; background: linear-gradient(135deg, #FF1744, #ff5252); cursor: pointer; transition: all 0.25s ease; box-shadow: 0 0 12px rgba(255,23,68,0.9), 0 2px 0 rgba(0,0,0,0.6), inset 0 2px 0 rgba(255,255,255,0.4); border: 2px solid #fff; transform: scale(1.1);'
                            : 'width: 12px; height: 12px; border-radius: 50%; background: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.25s ease; border: 2px solid rgba(255,255,255,0.8); box-shadow: inset 0 2px 4px rgba(0,0,0,0.4), 0 2px 0 rgba(0,0,0,0.4);';
                        dot.onclick = () => goToAdSlide(i);
                        adDotsWrapper.appendChild(dot);
                    }
                    adDotsContainer.style.display = 'flex';
                    
                    // Start auto-advance
                    startAdAutoAdvance();
                } else {
                    // Hide controls for single ad
                    adNavPrev.style.display = 'none';
                    adNavNext.style.display = 'none';
                    adDotsContainer.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Failed to load ads:', error);
                adSection.style.display = 'none';
            }
        }

        // Update buttons in bottom container based on current ad
        function updateAdButtons(index) {
            const adButtonsContainer = document.getElementById('adButtonsContainer');
            const slides = document.querySelectorAll('.premium-ad-slide');
            if (!slides[index]) return;
            
            const slide = slides[index];
            const isVideo = slide.getAttribute('data-video') === 'true';
            const adLink = slide.getAttribute('data-ad-link');
            const buttonText = slide.getAttribute('data-button-text');
            
            adButtonsContainer.innerHTML = '';
            
            // Add mute button for videos
            if (isVideo) {
                const muteButton = document.createElement('button');
                muteButton.className = 'ad-mute-button';
                muteButton.innerHTML = '<i class="fas fa-volume-mute"></i>';
                muteButton.setAttribute('data-muted', 'true');
                muteButton.setAttribute('data-slide-index', index);
                muteButton.style.cssText = 'background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); color: white; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 23, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);';
                
                muteButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const slideIndex = parseInt(this.getAttribute('data-slide-index'));
                    const targetSlide = document.querySelectorAll('.premium-ad-slide')[slideIndex];
                    const video = targetSlide.querySelector('video');
                    if (video) {
                        const isMuted = this.getAttribute('data-muted') === 'true';
                        video.muted = !isMuted;
                        this.setAttribute('data-muted', !isMuted);
                        this.innerHTML = isMuted ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
                        this.style.background = isMuted ? 'rgba(255, 23, 68, 0.9)' : 'rgba(0, 0, 0, 0.7)';
                        this.style.transform = 'scale(1.2)';
                        setTimeout(() => { this.style.transform = 'scale(1)'; }, 200);
                    }
                };
                
                muteButton.onmouseenter = function() {
                    this.style.transform = 'scale(1.15)';
                    this.style.boxShadow = '0 6px 16px rgba(0, 0, 0, 0.6), 0 0 30px rgba(255, 23, 68, 0.5), inset 0 2px 0 rgba(255, 255, 255, 0.3)';
                };
                muteButton.onmouseleave = function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 23, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
                };
                
                adButtonsContainer.appendChild(muteButton);
            }
            
            // Add CTA button if link is provided
            if (adLink && adLink.trim() !== '') {
                const ctaButton = document.createElement('a');
                ctaButton.href = adLink;
                ctaButton.target = '_blank';
                ctaButton.rel = 'noopener noreferrer';
                ctaButton.className = 'ad-cta-button';
                ctaButton.innerHTML = `<i class="fas fa-external-link-alt"></i> ${buttonText}`;
                ctaButton.style.cssText = 'background: linear-gradient(135deg, #FF1744, #ff5252); color: white; padding: 12px 24px; border-radius: 50px; font-weight: 800; font-size: 0.9rem; text-decoration: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 8px 24px rgba(255, 23, 68, 0.6), 0 0 40px rgba(255, 23, 68, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3); border: 3px solid rgba(255, 255, 255, 0.9); transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); text-transform: uppercase; letter-spacing: 0.08em; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); animation: ctaPulse 2s ease-in-out infinite;';
                
                ctaButton.onmouseenter = function() {
                    this.style.transform = 'scale(1.1) translateY(-2px)';
                    this.style.boxShadow = '0 12px 32px rgba(255, 23, 68, 0.8), 0 0 60px rgba(255, 23, 68, 0.6), inset 0 3px 0 rgba(255, 255, 255, 0.4)';
                    this.style.animation = 'none';
                };
                ctaButton.onmouseleave = function() {
                    this.style.transform = 'scale(1) translateY(0)';
                    this.style.boxShadow = '0 8px 24px rgba(255, 23, 68, 0.6), 0 0 40px rgba(255, 23, 68, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3)';
                    this.style.animation = 'ctaPulse 2s ease-in-out infinite';
                };
                
                adButtonsContainer.appendChild(ctaButton);
            }
        }

        // Navigate to specific ad slide
        function goToAdSlide(index) {
            if (index === currentAdIndex || totalAds <= 1) return;
            
            const slides = document.querySelectorAll('.premium-ad-slide');
            const dots = document.querySelectorAll('.premium-ad-dot');
            
            // Pause current video if exists
            const currentVideo = slides[currentAdIndex].querySelector('video');
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.currentTime = 0;
            }
            
            // Hide current
            slides[currentAdIndex].style.opacity = '0';
            slides[currentAdIndex].style.transform = 'translate3d(-50px, 0, 0) scale(0.95)';
            slides[currentAdIndex].classList.remove('active');
            if (dots[currentAdIndex]) {
                dots[currentAdIndex].style.background = 'rgba(255,255,255,0.5)';
                dots[currentAdIndex].style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.4), 0 2px 0 rgba(0,0,0,0.4)';
                dots[currentAdIndex].style.transform = 'scale(1)';
                dots[currentAdIndex].classList.remove('active');
            }
            
            // Show new
            currentAdIndex = index;
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    slides[currentAdIndex].style.transform = 'translate3d(0, 0, 0) scale(1)';
                    slides[currentAdIndex].style.opacity = '1';
                    slides[currentAdIndex].classList.add('active');
                    if (dots[currentAdIndex]) {
                        dots[currentAdIndex].style.background = 'linear-gradient(135deg, #FF1744, #ff5252)';
                        dots[currentAdIndex].style.boxShadow = '0 0 12px rgba(255,23,68,0.9), 0 2px 0 rgba(0,0,0,0.6), inset 0 2px 0 rgba(255,255,255,0.4)';
                        dots[currentAdIndex].style.transform = 'scale(1.1)';
                        dots[currentAdIndex].classList.add('active');
                    }
                    
                    // Play new video if exists
                    const newVideo = slides[currentAdIndex].querySelector('video');
                    if (newVideo) {
                        newVideo.play().catch(e => console.log('Video autoplay prevented:', e));
                    }
                    
                    // Update buttons for new ad
                    updateAdButtons(currentAdIndex);
                });
            });
            
            // Reset auto-advance timer (only for non-video ads)
            if (totalAds > 1) {
                const currentAd = adsDataGlobal[currentAdIndex];
                const isVideo = currentAd && currentAd.url.toLowerCase().match(/\.(mp4|webm|ogg)$/);
                if (!isVideo) {
                    startAdAutoAdvance();
                } else {
                    // Clear timer for video ads (they advance on 'ended' event)
                    if (adAutoAdvanceInterval) {
                        clearInterval(adAutoAdvanceInterval);
                        adAutoAdvanceInterval = null;
                    }
                }
            }
        }

        // Premium Ad Navigation Function
        function navigatePremiumAd(direction) {
            if (totalAds <= 1) return;
            
            let newIndex = currentAdIndex + direction;
            if (newIndex < 0) newIndex = totalAds - 1;
            if (newIndex >= totalAds) newIndex = 0;
            
            goToAdSlide(newIndex);
        }

        // Auto-advance ads
        function startAdAutoAdvance() {
            if (adAutoAdvanceInterval) {
                clearInterval(adAutoAdvanceInterval);
            }
            
            if (totalAds > 1) {
                // Check if current ad is a video
                const currentAd = adsDataGlobal[currentAdIndex];
                const isVideo = currentAd && currentAd.url.toLowerCase().match(/\.(mp4|webm|ogg)$/);
                
                // Only set interval for images/gifs (videos advance on 'ended' event)
                if (!isVideo) {
                    adAutoAdvanceInterval = setInterval(() => {
                        navigatePremiumAd(1);
                    }, 5000); // 5 seconds per image/gif
                }
            }
        }

        // Initialize ads on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadPremiumAds();
        });
    
        const REMOTE_METRICS_ENDPOINT = window.METRICS_ENDPOINT || 'http://localhost:8080/api/metrics';
        const LOCAL_METRICS_FALLBACK = 'site_metrics.json';
        
        // Embedded fallback data (loaded from site_metrics.json at build time)
        const EMBEDDED_FALLBACK_DATA = {
            "summary": {
                "builder_count": 5,
                "total_completed": 142,
                "total_requests": 189,
                "total_ratings": 67,
                "request_completion_ratio": 0.75
            },
            "server": {
                "total_members": 1234,
                "joined_today": 12,
                "active_shops": 3,
                "avg_response_time": 3600
            },
            "topBuilders": [
                {
                    "shop_name": "Epic Builds Co",
                    "completed_projects": 45,
                    "average_rating": 4.8,
                    "thread_id": null,
                    "avatar_url": null,
                    "server_id": null,
                    "url": "#"
                },
                {
                    "shop_name": "Luxury Homes Studio",
                    "completed_projects": 38,
                    "average_rating": 4.9,
                    "thread_id": null,
                    "avatar_url": null,
                    "server_id": null,
                    "url": "#"
                },
                {
                    "shop_name": "Modern Architecture",
                    "completed_projects": 32,
                    "average_rating": 4.7,
                    "thread_id": null,
                    "avatar_url": null,
                    "server_id": null,
                    "url": "#"
                },
                {
                    "shop_name": "Creative Designs",
                    "completed_projects": 27,
                    "average_rating": 4.6,
                    "thread_id": null,
                    "avatar_url": null,
                    "server_id": null,
                    "url": "#"
                }
            ],
            "activityLog": [
                {
                    "type": "accepted",
                    "shop_name": "Epic Builds Co",
                    "message": "Epic Builds Co accepted a new commission request",
                    "timestamp": 1733270400,
                    "thread_id": null,
                    "server_id": null,
                    "url": null
                },
                {
                    "type": "completed",
                    "shop_name": "Luxury Homes Studio",
                    "message": "Luxury Homes Studio completed a modern mansion build",
                    "timestamp": 1733266800,
                    "thread_id": null,
                    "server_id": null,
                    "url": null
                },
                {
                    "type": "accepted",
                    "shop_name": "Modern Architecture",
                    "message": "Modern Architecture accepted a request for a villa",
                    "timestamp": 1733263200,
                    "thread_id": null,
                    "server_id": null,
                    "url": null
                }
            ],
            "pipeline": [
                {
                    "label": "Pending Requests",
                    "value": 15,
                    "trend": "5 new today ¬∑ 23 responded",
                    "max": 50
                },
                {
                    "label": "Active Shops",
                    "value": 3,
                    "trend": "2 open ¬∑ 1 limited",
                    "max": 20
                },
                {
                    "label": "Requests (7d)",
                    "value": 47,
                    "trend": "32 accepted ¬∑ 8 rejected",
                    "max": 100
                }
            ],
            "insights": [
                {
                    "title": "Completion Rate",
                    "detail": "75.13% of requests fulfilled (142 completed)",
                    "score": "On track",
                    "status": "good"
                },
                {
                    "title": "Acceptance Rate",
                    "detail": "80.0% of requests accepted (32 accepted, 8 rejected)",
                    "score": "Healthy",
                    "status": "good"
                },
                {
                    "title": "Live Shops",
                    "detail": "3 shops currently accepting commissions",
                    "score": "Healthy",
                    "status": "good"
                },
                {
                    "title": "Queue Health",
                    "detail": "15 requests awaiting response",
                    "score": "Manageable",
                    "status": "good"
                }
            ],
            "news": [
                {
                    "type": "game_update",
                    "title": "Welcome to Crumbl Crafts!",
                    "description": "Your premium Bloxburg builder dashboard is live. News feed ready.",
                    "source": "Dashboard",
                    "timestamp": 1733270400,
                    "url": "#",
                    "icon": "fa-cookie-bite"
                },
                {
                    "type": "trend",
                    "title": "YouTube Trending Videos",
                    "description": "Latest Bloxburg builds and tutorials will appear here",
                    "source": "YouTube",
                    "timestamp": 1733266800,
                    "url": "https://youtube.com/results?search_query=bloxburg",
                    "icon": "fa-youtube"
                },
                {
                    "type": "community",
                    "title": "Builder Updates",
                    "description": "Community announcements and builder spotlights",
                    "source": "Crumbl Crafts",
                    "timestamp": 1733263200,
                    "url": "#",
                    "icon": "fa-bullhorn"
                }
            ],
            "meta": {
                "generated_at": 1733270400,
                "mode": "embedded",
                "refresh_interval": 2000
            }
        };
        const FORUM_CHANNEL_BASE = 'https://discord.com/channels/';
        const ACTIVITY_RETENTION_DAYS = 7;
        const MAX_ACTIVITY_ITEMS = 10000;
        const REFRESH_INTERVAL = 2000; // 2 seconds - optimized for performance
        const FETCH_TIMEOUT = 5000; // 5 second timeout for reliability
        
        const formatNumber = (v) => new Intl.NumberFormat('en-US').format(v ?? 0);
        const formatTime = (s) => { 
            if (!s || s < 60) return `${Math.round(s||0)}s`; 
            if (s < 3600) return `${Math.round(s/60)}m`; 
            return `${(s/3600).toFixed(1)}h`; 
        };
        const formatDuration = (seconds) => {
            if (!seconds || seconds === 0) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m`;
            return `${Math.round(seconds)}s`;
        };
        const timeAgo = (ts) => { 
            if (!ts) return 'Just now'; 
            const d = Date.now()/1000 - ts; 
            if (d < 60) return 'Just now'; 
            if (d < 3600) return `${Math.floor(d/60)}m ago`; 
            if (d < 86400) return `${Math.floor(d/3600)}h ago`; 
            return `${Math.floor(d/86400)}d ago`; 
        };
        
        const statsConfig = [
            { key: 'builder_count', label: 'Builders', icon: 'fa-users', color: '#00d4ff' },
            { key: 'total_completed', label: 'Completed', icon: 'fa-check-circle', color: '#10b981' },
            { key: 'total_requests', label: 'Requests', icon: 'fa-paper-plane', color: '#7c3aed' },
            { key: 'total_ratings', label: 'Ratings', icon: 'fa-star', color: '#f59e0b' },
            { key: 'total_members', label: 'Members', icon: 'fa-users', color: '#8b5cf6' },
            { key: 'active_shops', label: 'Active Shops', icon: 'fa-store', color: '#10b981' },
            { key: 'avg_response_time', label: 'Avg Response', icon: 'fa-clock', color: '#00d4ff', format: 'duration' }
        ];
        
        const activityIcons = {
            sent: 'fa-paper-plane',
            accepted: 'fa-check',
            rejected: 'fa-times',
            completed: 'fa-flag-checkered',
            rating: 'fa-star',
            new_request_thread: 'fa-comments',
            task_claimed: 'fa-handshake',
            member_join: 'fa-user-plus',
            member_leave: 'fa-user-minus'
        };
        // Local storage for activity feed persistence
        let activityCache = [];
        let previousStats = {};
        let lastActivityCount = 0;
        
        // Audio notification for new activity
        let audioContext = null;
        let audioUnlocked = false;
        
        const unlockAudio = () => {
            if (!audioUnlocked && !audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioUnlocked = true;
                console.log('‚úì Audio unlocked for notifications');
            }
        };
        
        const playNotificationSound = () => {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Resume context if suspended (browser autoplay policy)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
                debug.log('üîî Notification played');
            } catch (e) {
                debug.warn('Sound failed:', e.message);
            }
        };
        
        const loadActivityCache = () => {
            try {
                // Check cache version
                const cacheVersion = localStorage.getItem('crumbl_activity_cache_version');
                const CACHE_VERSION = '2'; // Increment to invalidate old cache
                
                if (cacheVersion !== CACHE_VERSION) {
                    console.log('Activity cache version mismatch, clearing old cache');
                    localStorage.removeItem('crumbl_activity_feed');
                    localStorage.setItem('crumbl_activity_cache_version', CACHE_VERSION);
                    activityCache = [];
                    return;
                }
                
                const cached = localStorage.getItem('crumbl_activity_feed');
                if (cached) {
                    activityCache = JSON.parse(cached);
                    // Remove entries older than 7 days
                    const cutoff = Date.now() / 1000 - (ACTIVITY_RETENTION_DAYS * 86400);
                    const beforeClean = activityCache.length;
                    activityCache = activityCache.filter(item => item.timestamp > cutoff);
                    
                    // Sort by timestamp descending (newest first)
                    activityCache.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    
                    if (beforeClean > activityCache.length) {
                        console.log(`Cleaned ${beforeClean - activityCache.length} old activities from cache`);
                        saveActivityCache();
                    }
                }
            } catch (e) {
                console.warn('Failed to load activity cache:', e);
                activityCache = [];
            }
        };
        
        const saveActivityCache = () => {
            try {
                localStorage.setItem('crumbl_activity_feed', JSON.stringify(activityCache));
            } catch (e) {
                console.warn('Failed to save activity cache:', e);
            }
        };
        
        const cleanOldActivities = () => {
            const cutoff = Date.now() / 1000 - (ACTIVITY_RETENTION_DAYS * 86400);
            const originalLength = activityCache.length;
            activityCache = activityCache.filter(item => item.timestamp && item.timestamp > cutoff);
            
            if (activityCache.length !== originalLength) {
                console.log(`Cleaned ${originalLength - activityCache.length} old activity entries`);
                saveActivityCache();
            }
        };
        
        const mergeActivities = (newActivities) => {
            if (!Array.isArray(newActivities)) {
                console.warn('mergeActivities: newActivities is not an array', newActivities);
                return;
            }
            
            // If backend sends empty array and we have cached items, clean old ones
            if (newActivities.length === 0 && activityCache.length > 0) {
                cleanOldActivities();
                return;
            }
            
            if (newActivities.length === 0) {
                return;
            }
            
            let addedCount = 0;
            
            // Add new activities that don't exist in cache
            newActivities.forEach(item => {
                if (!item.timestamp) return; // Skip invalid items
                
                // Create unique ID for better duplicate detection
                const itemId = `${item.timestamp}-${item.type}-${item.shop_name || ''}-${item.message?.substring(0, 50) || ''}`;
                
                const exists = activityCache.some(cached => {
                    const cachedId = `${cached.timestamp}-${cached.type}-${cached.shop_name || ''}-${cached.message?.substring(0, 50) || ''}`;
                    return cachedId === itemId;
                });
                
                if (!exists) {
                    activityCache.unshift(item);
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                console.log(`Added ${addedCount} new activity entries`);
                
                // Play notification sound for new activities
                if (lastActivityCount > 0) { // Don't play on initial load
                    playNotificationSound();
                }
                
                // Sort by timestamp descending (newest first)
                activityCache.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Limit to MAX_ACTIVITY_ITEMS
                if (activityCache.length > MAX_ACTIVITY_ITEMS) {
                    activityCache = activityCache.slice(0, MAX_ACTIVITY_ITEMS);
                }
                
                // Clean old items
                cleanOldActivities();
                
                saveActivityCache();
            }
        };
        
        const placeholderData = {
            summary: { 
                builder_count: 0, 
                total_completed: 0, 
                total_requests: 0, 
                total_ratings: 0, 
                request_completion_ratio: 0 
            },
            server: {
                total_members: 0,
                joined_today: 0,
                active_shops: 0,
                avg_response_time: 0
            },
            topBuilders: [],
            activityLog: [],
            pipeline: [
                { label: 'Queued Requests', value: 0, trend: 'No data yet', max: 50 },
                { label: 'Active Builds', value: 0, trend: 'No data yet', max: 30 },
                { label: 'Completed (7d)', value: 0, trend: 'No data yet', max: 50 },
            ],
            insights: [
                { title: 'Completion Rate', detail: 'Waiting for data', score: 'N/A', status: 'good' },
                { title: 'Request Velocity', detail: 'Waiting for data', score: 'N/A', status: 'good' },
                { title: 'Builder Availability', detail: 'Waiting for data', score: 'N/A', status: 'good' },
                { title: 'Queue Health', detail: 'Waiting for data', score: 'N/A', status: 'good' },
            ],
        };
        const withCacheBust = (url) => url.includes('?') ? `${url}&v=${Date.now()}` : `${url}?v=${Date.now()}`;
        
        // Fetch with timeout
        async function fetchWithTimeout(url, timeout = FETCH_TIMEOUT) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    signal: controller.signal,
                    cache: 'no-store',
                    keepalive: true,
                    priority: 'high',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Accept-Encoding': 'gzip, deflate, br'
                    }
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }
        
        async function fetchFrom(url) { 
            const r = await fetchWithTimeout(withCacheBust(url));
            if (!r.ok) throw new Error(`HTTP ${r.status}`); 
            const p = await r.json(); 
            return p; 
        }
        
        // Feature flags
        const BUILD_MUSEUM_ENABLED = false; // Set to true to enable the Build Museum

        // Performance optimizations
        const DEBUG_MODE = false; // Set true for development
        const debug = {
            log: DEBUG_MODE ? console.log.bind(console) : () => {},
            warn: DEBUG_MODE ? console.warn.bind(console) : () => {},
            error: console.error.bind(console)
        };
        
        // DOM element cache for performance
        const DOM_CACHE = {};
        function getElement(id) {
            if (!DOM_CACHE[id]) DOM_CACHE[id] = document.getElementById(id);
            return DOM_CACHE[id];
        }
        
        let isOnline = true;
        let consecutiveFailures = 0;
        let lastSuccessfulFetch = Date.now();
        let pendingFetch = null;
        
        async function fetchMetrics() {
            // Deduplicate - return existing pending request if one is in flight
            if (pendingFetch) {
                return pendingFetch;
            }
            
            const startTime = performance.now();
            
            pendingFetch = (async () => {
                try { 
                    const data = await fetchFrom(REMOTE_METRICS_ENDPOINT);
                    
                    // Success - reset failure counter
                    consecutiveFailures = 0;
                    lastSuccessfulFetch = Date.now();
                    isOnline = true;
                    
                    const latency = Math.round(performance.now() - startTime);
                    debug.log(`‚úì Fetched in ${latency}ms`);
                    
                    return data;
                } catch (e) {
                    consecutiveFailures++;
                    
                    if (consecutiveFailures > 2) {
                        isOnline = false;
                    }
                    
                    // Only log non-connection errors to reduce console spam
                    if (!e.message?.includes('Failed to fetch') && e.name !== 'TypeError') {
                        debug.warn(`‚úó Remote failed (attempt ${consecutiveFailures}):`, e.message);
                    }
                    
                    // Try local fallback file first
                    try { 
                        const data = await fetchFrom(LOCAL_METRICS_FALLBACK);
                        debug.log('‚úì Using local fallback file');
                        return data;
                    } catch (e2) { 
                        debug.warn('‚úó Local fallback file failed:', e2.message); 
                        debug.log('‚úì Using embedded fallback data');
                        return EMBEDDED_FALLBACK_DATA; 
                    }
                } finally {
                    pendingFetch = null;
                }
            })();
            
            return pendingFetch;
        }
        
        function renderStats(data) {
            const summary = { ...(data.summary || {}), ...(data.server || {}) };
            const grid = getElement('statsGrid');
            if (!grid) return;
            
            debug.log('üìä renderStats:', { count: statsConfig.length });
            
            // Use requestAnimationFrame for smoother rendering
            requestAnimationFrame(() => {
                statsConfig.forEach((stat, i) => {
                    const value = summary[stat.key] ?? 0;
                    const displayValue = stat.format === 'duration' ? formatDuration(value) : formatNumber(value);
                    const previousValue = previousStats[stat.key];
                    const hasChanged = previousValue !== undefined && previousValue !== value;
                    
                    // Find existing card or create new one
                    let card = grid.querySelector(`[data-stat="${stat.key}"]`);
                
                if (!card) {
                    card = document.createElement('div');
                    card.className = 'stat-card';
                    card.setAttribute('data-stat', stat.key);
                    card.innerHTML = `
                        <div class="icon-wrapper" style="color: ${stat.color}">
                            <i class="fas ${stat.icon}"></i>
                        </div>
                        <div class="stat-content">
                            <span class="label">${stat.label}</span>
                            <span class="value" data-value-container></span>
                        </div>
                    `;
                    grid.appendChild(card);
                }
                
                const valueContainer = card.querySelector('[data-value-container]');
                if (valueContainer && valueContainer.textContent !== displayValue) {
                    valueContainer.textContent = displayValue;
                    
                    if (hasChanged) {
                        // Add count-up animation only when value changes
                        valueContainer.classList.remove('count-up');
                        void valueContainer.offsetWidth; // Trigger reflow
                        valueContainer.classList.add('count-up');
                        
                        // Add pulse effect to card
                        card.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            card.style.transform = '';
                        }, 300);
                    }
                }
                
                    previousStats[stat.key] = value;
                });
            });
        }
        
        function renderBuilders(builders) {
            const grid = document.getElementById('buildersGrid');
            const topBuilders = (builders || []).slice(0, 10);
            
            if (!topBuilders.length) {
                if (!grid.querySelector('p')) {
                    grid.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px 0;">No builders data available</p>';
                }
                return;
            }
            
            // Separate top 3 (podium) from the rest
            const top3 = topBuilders.slice(0, 3);
            const rest = topBuilders.slice(3);
            
            let html = '';
            
            // Render podium for top 3
            if (top3.length > 0) {
                html += '<div class="podium-container">';
                top3.forEach((builder, i) => {
                    const url = builder.url || 
                               (builder.thread_id && builder.server_id ? `${FORUM_CHANNEL_BASE}${builder.server_id}/${builder.thread_id}` : '#');
                    const avatar = builder.avatar_url && builder.avatar_url !== 'null' && builder.avatar_url !== ''
                        ? `<img src="${builder.avatar_url}" alt="${builder.shop_name}" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-home\\' style=\\'font-size: 32px; color: var(--primary);\\' ></i>';" />` 
                        : `<i class="fas fa-home" style="font-size: 32px; color: var(--primary);"></i>`;
                    const rankBadge = `<div class="rank-badge">#${i + 1}</div>`;
                    
                    html += `
                        <a href="${url}" target="_blank" class="podium-card rank-${i + 1}" title="Visit ${builder.shop_name}">
                            ${rankBadge}
                            <div class="builder-avatar">${avatar}</div>
                            <div class="builder-info">
                                <div class="builder-name">${builder.shop_name}</div>
                                <div class="builder-meta">
                                    <span class="stat">
                                        <span class="stat-label">Completed</span>
                                        <span class="stat-value">${builder.completed_projects || 0}</span>
                                    </span>
                                    <span class="stat rating">
                                        <span class="stat-label">Rating</span>
                                        <span class="stat-value">${(builder.average_rating || 0).toFixed(1)} <i class="fas fa-star" style="font-size: 0.7rem;"></i></span>
                                    </span>
                                </div>
                            </div>
                        </a>
                    `;
                });
                html += '</div>';
            }
            
            // Render compact list for rest (2 per row)
            if (rest.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
                rest.forEach((builder, i) => {
                    const rank = i + 4;
                    const url = builder.url || 
                               (builder.thread_id && builder.server_id ? `${FORUM_CHANNEL_BASE}${builder.server_id}/${builder.thread_id}` : '#');
                    const avatar = builder.avatar_url && builder.avatar_url !== 'null' && builder.avatar_url !== ''
                        ? `<img src="${builder.avatar_url}" alt="${builder.shop_name}" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-home\\' style=\\'font-size: 20px; color: var(--primary);\\' ></i>';" />` 
                        : `<i class="fas fa-home" style="font-size: 20px; color: var(--primary);"></i>`;
                    
                    html += `
                        <a href="${url}" target="_blank" class="builder-card" title="Visit ${builder.shop_name}">
                            <span class="rank-number">${rank}</span>
                            <div class="builder-avatar">${avatar}</div>
                            <div class="builder-info">
                                <div class="builder-name">${builder.shop_name}</div>
                                <div class="builder-meta">
                                    <span class="stat">
                                        <span class="stat-label">Completed:</span>
                                        <span class="stat-value">${builder.completed_projects || 0}</span>
                                    </span>
                                    <span class="stat rating">
                                        <span class="stat-label">Rating:</span>
                                        <span class="stat-value">${(builder.average_rating || 0).toFixed(1)} <i class="fas fa-star" style="font-size: 0.65rem;"></i></span>
                                    </span>
                                </div>
                            </div>
                        </a>
                    `;
                });
                html += '</div>';
            }
            
            grid.innerHTML = html;
        }
        
        function renderActivityFeed(activities) {
            const list = getElement('activityList');
            const count = getElement('activityCount');
            if (!list) return;
            
            // Merge with cache
            mergeActivities(activities);
            
            // Update activity count - batch DOM updates
            const newCount = activityCache.length;
            if (count && count.textContent !== String(newCount)) {
                count.textContent = newCount;
            }
            if (lastActivityCount !== newCount) {
                lastActivityCount = newCount;
            }
            
            if (!activityCache.length) {
                if (list.children.length !== 1 || !list.querySelector('p')) {
                    list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 60px 20px;">No recent activity</p>';
                }
                return;
            }
            
            const activityHTML = activityCache.map((item, index) => {
                const icon = activityIcons[item.type] || activityIcons.sent;
                const typeClass = `type-${item.type}`;
                // Use the URL from backend if available, otherwise construct from thread_id/server_id
                const activityUrl = item.url || (item.thread_id && item.server_id ? `${FORUM_CHANNEL_BASE}${item.server_id}/${item.thread_id}` : null);
                
                // If we have a URL, make the entire activity item a clickable link
                const itemWrapper = activityUrl 
                    ? `<a href="${activityUrl}" target="_blank" class="activity-item" style="text-decoration: none; color: inherit; display: flex; cursor: pointer;">` 
                    : `<div class="activity-item">`;
                const itemWrapperClose = activityUrl ? `</a>` : `</div>`;
                
                return `
                    ${itemWrapper}
                        <div class="activity-icon ${typeClass}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-message">${item.message || `Activity at ${item.shop_name || 'Unknown'}`}</div>
                            <div class="activity-meta">
                                <span class="activity-time">
                                    <i class="far fa-clock"></i>
                                    ${timeAgo(item.timestamp)}
                                </span>
                                <span class="activity-type-badge">${item.type || 'event'}</span>
                            </div>
                        </div>
                    ${itemWrapperClose}
                `;
            }).join('');
            
            list.innerHTML = activityHTML;
        }
        
        function renderNews(news) {
            const list = getElement('newsList');
            if (!list) return;
            
            debug.log('üì∞ renderNews:', { hasData: !!news });
            
            let items = news || [];
            
            // Use sample data if no news available
            if (!items || !Array.isArray(items) || items.length === 0) {
                debug.log('Using fallback news data');
                items = [
                    {
                        type: 'game_update',
                        title: 'Welcome to Crumbl Crafts!',
                        description: 'Your premium Bloxburg builder dashboard is live. News feed ready.',
                        source: 'Dashboard',
                        timestamp: Math.floor(Date.now() / 1000),
                        url: '#',
                        icon: 'fa-cookie-bite'
                    },
                    {
                        type: 'trend',
                        title: 'YouTube Trending Videos',
                        description: 'Latest Bloxburg builds and tutorials will appear here',
                        source: 'YouTube',
                        timestamp: Math.floor(Date.now() / 1000) - 3600,
                        url: 'https://youtube.com/results?search_query=bloxburg',
                        icon: 'fa-youtube'
                    },
                    {
                        type: 'community',
                        title: 'Builder Updates',
                        description: 'Community announcements and builder spotlights',
                        source: 'Crumbl Crafts',
                        timestamp: Math.floor(Date.now() / 1000) - 7200,
                        url: '#',
                        icon: 'fa-bullhorn'
                    }
                ];
            }
            
            if (!items.length) {
                list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px 0;">No news available</p>';
                return;
            }
            
            const newsHTML = items.map((item, i) => {
                const typeClass = `type-${item.type || 'community'}`;
                const icon = item.icon || 'fa-bullhorn';
                
                // Extract YouTube thumbnail
                let thumbnail = item.thumbnail || '';
                if (!thumbnail && item.url) {
                    const youtubeMatch = item.url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
                    if (youtubeMatch) {
                        thumbnail = `https://img.youtube.com/vi/${youtubeMatch[1]}/mqdefault.jpg`;
                    }
                }
                
                const iconContent = thumbnail 
                    ? `<img src="${thumbnail}" alt="" loading="lazy" onerror="this.style.display='none'; this.parentElement.querySelector('i').style.display='block';">` 
                    : '';
                
                return `
                    <a href="${item.url || '#'}" target="_blank" class="news-card">
                        <div class="news-icon ${typeClass}" ${thumbnail ? `style="background-image: url('${thumbnail}')"` : ''}>
                            ${iconContent}
                            <i class="fas ${icon}" style="${thumbnail ? 'display:none;' : ''}"></i>
                        </div>
                        <div class="news-content">
                            <div class="news-title">${item.title}</div>
                            <div class="news-description">${item.description}</div>
                            <div class="news-meta">
                                <span class="news-source">
                                    <i class="fas fa-tag"></i>
                                    ${item.source || 'Unknown'}
                                </span>
                                <span>¬∑</span>
                                <span>
                                    <i class="far fa-clock"></i>
                                    ${timeAgo(item.timestamp)}
                                </span>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
            
            list.innerHTML = newsHTML;
        }
        
        // ==========================================
        // Build Museum - Firebase Firestore Integration
        // ==========================================
        // Features:
        // - Upload images (max 5MB) and videos (max 50MB, 30s)
        // - Real-time loading from Firestore
        // - User ratings (1-5 stars) with average calculation
        // - Comment system with user authentication
        // - Firebase Storage for media files
        // ==========================================
        
        let buildMuseumBuilds = [];
        
        async function initBuildMuseum() {
            try {
                // Load builds from Firestore
                await loadBuildsFromFirestore();
                renderBuildMuseum();
            } catch (error) {
                console.error('Error initializing Build Museum:', error);
                // Show error message in grid
                const grid = getElement('buildMuseumGrid');
                if (grid) {
                    grid.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px 0;">Error loading builds. Please try again later.</p>';
                }
            }
        }
        
        async function loadBuildsFromFirestore() {
            if (!BUILD_MUSEUM_ENABLED) return;
            try {
                if (!BUILD_MUSEUM_ENABLED) {
                    console.warn('Build Museum disabled: skipping Firestore upload');
                    return false;
                }
                const buildsCollection = collection(window.firestore, 'builds');
                const buildsQuery = firestoreQuery(buildsCollection, orderBy('createdAt', 'desc'), limit(50));
                const snapshot = await getDocs(buildsQuery);
                
                buildMuseumBuilds = [];
                snapshot.forEach((doc) => {
                    buildMuseumBuilds.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Loaded ${buildMuseumBuilds.length} builds from Firestore`);
            } catch (error) {
                console.error('Error loading builds:', error);
                buildMuseumBuilds = [];
            }
        }
        
        function renderBuildMuseum() {
            if (!BUILD_MUSEUM_ENABLED) return;
            const grid = getElement('buildMuseumGrid');
            if (!grid) return;
            
            if (buildMuseumBuilds.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No builds yet. Be the first to share your amazing Bloxburg build!</p>';
                return;
            }
            
            const buildsHTML = buildMuseumBuilds.map(build => `
                <div class="build-card" onclick="openBuildModal('${build.id}')">
                    <div class="build-card-media">
                        ${build.type === 'video' 
                            ? `<video src="${build.mediaUrl}" loop muted loading="lazy"></video>` 
                            : `<img src="${build.mediaUrl}" alt="${build.title}" loading="lazy" />`
                        }
                        <div class="build-card-type">${build.type === 'video' ? 'üìπ Video' : 'üñºÔ∏è Image'}</div>
                    </div>
                    <div class="build-card-content">
                        <div class="build-card-title">${build.title}</div>
                        <div class="build-card-author">
                            <i class="fas fa-user"></i> ${build.author}
                        </div>
                        <div class="build-card-stats">
                            <div class="build-card-rating">
                                <i class="fas fa-star"></i> ${(build.rating || 0).toFixed(1)} (${build.ratingCount || 0})
                            </div>
                            <div class="build-card-actions">
                                <button class="build-action-btn" onclick="event.stopPropagation(); rateBuild('${build.id}', 5)">
                                    <i class="fas fa-thumbs-up"></i> ${build.ratingCount || 0}
                                </button>
                                <button class="build-action-btn" onclick="event.stopPropagation(); openBuildModal('${build.id}')">
                                    <i class="fas fa-comment"></i> ${(build.comments || []).length}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            grid.innerHTML = buildsHTML;
        }
        
        function openBuildModal(buildId) {
            if (!BUILD_MUSEUM_ENABLED) { alert('Build Museum is temporarily disabled'); return; }
            const build = buildMuseumBuilds.find(b => b.id === buildId);
            if (!build) return;
            
            const modal = document.createElement('div');
            modal.className = 'build-modal show';
            modal.innerHTML = `
                <div class="build-modal-content">
                    <button class="build-modal-close" onclick="this.closest('.build-modal').remove()">√ó</button>
                    <div class="build-modal-media">
                        ${build.type === 'video' 
                            ? `<video src="${build.mediaUrl}" controls autoplay loop></video>` 
                            : `<img src="${build.mediaUrl}" alt="${build.title}" />`
                        }
                    </div>
                    <div class="build-modal-body">
                        <h2 class="build-modal-title">${build.title}</h2>
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
                            <i class="fas fa-user"></i> ${build.author} ¬∑ 
                            <i class="fas fa-star" style="color: #FFD700;"></i> ${build.rating.toFixed(1)} (${build.ratingCount} ratings)
                        </div>
                        <p class="build-modal-description">${build.description}</p>
                        
                        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                            ${[1,2,3,4,5].map(star => `
                                <button onclick="rateBuild(${buildId}, ${star})" style="background: ${star <= Math.round(build.rating) ? '#FFD700' : 'rgba(255, 255, 255, 0.1)'}; border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-star"></i>
                                </button>
                            `).join('')}
                        </div>
                        
                        <div class="build-comments">
                            <h3 style="font-size: 1.1rem; font-weight: 800; margin-bottom: 12px;">
                                <i class="fas fa-comments"></i> Comments (${build.comments.length})
                            </h3>
                            <div class="build-comment-input">
                                <input type="text" id="commentInput${buildId}" placeholder="Add a comment..." />
                                <button onclick="addComment(${buildId})">Post</button>
                            </div>
                            <div id="commentsContainer${buildId}">
                                ${build.comments.map(c => `
                                    <div class="build-comment">
                                        <div class="build-comment-author">${c.author}</div>
                                        <div class="build-comment-text">${c.text}</div>
                                    </div>
                                `).join('') || '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No comments yet. Be the first!</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }
        
        async function rateBuild(buildId, stars) {
            if (!BUILD_MUSEUM_ENABLED) { alert('Build Museum is temporarily disabled'); return; }
            if (!currentUser) {
                alert('Please sign in to rate builds!');
                return;
            }
            
            try {
                const build = buildMuseumBuilds.find(b => b.id === buildId);
                if (!build) return;
                
                // Update rating in Firestore
                const buildRef = doc(window.firestore, 'builds', buildId);
                const ratings = build.ratings || {};
                ratings[currentUser.uid] = stars;
                
                // Calculate new average
                const ratingValues = Object.values(ratings);
                const newRating = ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length;
                
                await updateDoc(buildRef, {
                    ratings: ratings,
                    rating: newRating,
                    ratingCount: ratingValues.length
                });
                
                // Update local data
                build.ratings = ratings;
                build.rating = newRating;
                build.ratingCount = ratingValues.length;
                
                renderBuildMuseum();
                alert(`Rated ${stars} stars! Thank you for your feedback.`);
            } catch (error) {
                console.error('Rating error:', error);
                alert('Failed to rate build. Please try again.');
            }
        }
        
        async function addComment(buildId) {
            if (!BUILD_MUSEUM_ENABLED) { alert('Build Museum is temporarily disabled'); return; }
            if (!currentUser) {
                alert('Please sign in to comment!');
                return;
            }
            
            const input = document.getElementById(`commentInput${buildId}`);
            const text = input.value.trim();
            if (!text) return;
            
            try {
                const build = buildMuseumBuilds.find(b => b.id === buildId);
                if (!build) return;
                
                const newComment = {
                    author: currentUser.displayName || currentUser.email || 'Anonymous',
                    authorId: currentUser.uid,
                    text: text,
                    timestamp: Date.now()
                };
                
                // Update Firestore
                const buildRef = doc(window.firestore, 'builds', buildId);
                await updateDoc(buildRef, {
                    comments: arrayUnion(newComment)
                });
                
                // Update local data
                if (!build.comments) build.comments = [];
                build.comments.push(newComment);
                
                input.value = '';
                
                // Refresh comments display
                const container = document.getElementById(`commentsContainer${buildId}`);
                container.innerHTML = build.comments.map(c => `
                    <div class="build-comment">
                        <div class="build-comment-author">${c.author}</div>
                        <div class="build-comment-text">${c.text}</div>
                    </div>
                `).join('');
                
                renderBuildMuseum();
            } catch (error) {
                console.error('Comment error:', error);
                alert('Failed to add comment. Please try again.');
            }
        }
        
        // Upload build functionality
        async function uploadBuild(file, title, description) {
            // Safely resolve the authenticated user - avoid ReferenceError if `currentUser` isn't defined in this scope
            const user = (typeof currentUser !== 'undefined' && currentUser) || window.currentUser || (window.firebaseAuth && window.firebaseAuth.currentUser) || (typeof auth !== 'undefined' && auth.currentUser) || null;
            if (!user) {
                alert('Please sign in to upload builds!');
                return false;
            }

            try {
                console.log('Starting upload...', { title, description, file: file?.name, user: user && (user.uid || user.email) });
                
                // Validate file
                const maxImageSize = 5 * 1024 * 1024; // 5MB
                const maxVideoSize = 50 * 1024 * 1024; // 50MB
                const isVideo = file.type.startsWith('video/');
                const isImage = file.type.startsWith('image/');
                
                if (!isVideo && !isImage) {
                    alert('Please upload an image or video file.');
                    return;
                }
                
                if (isImage && file.size > maxImageSize) {
                    alert('Image size must be less than 5MB.');
                    return;
                }
                
                if (isVideo && file.size > maxVideoSize) {
                    alert('Video size must be less than 50MB.');
                    return;
                }
                
                // Show uploading message
                const uploadBtn = document.getElementById('uploadSubmitBtn');
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                    uploadBtn.disabled = true;
                }
                
                // Upload file to Firebase Storage
                const timestamp = Date.now();
                const fileExtension = file.name.split('.').pop();
                const fileName = `builds/${user.uid}/${timestamp}.${fileExtension}`;
                
                console.log('Uploading to storage:', fileName);
                const fileRef = storageRef(window.firebaseStorage, fileName);
                
                const uploadTask = await uploadBytes(fileRef, file);
                console.log('File uploaded to storage:', uploadTask);
                
                const mediaUrl = await getDownloadURL(fileRef);
                console.log('Got download URL:', mediaUrl);
                
                // Add build to Firestore
                const buildsCollection = collection(window.firestore, 'builds');
                const buildData = {
                    title: title,
                    description: description || '',
                    author: user.displayName || user.email || 'Anonymous',
                    authorId: user.uid,
                    authorPhoto: user.photoURL || '',
                    type: isVideo ? 'video' : 'image',
                    mediaUrl: mediaUrl,
                    rating: 0,
                    ratingCount: 0,
                    ratings: {},
                    views: 0,
                    comments: [],
                    createdAt: firestoreTimestamp()
                };
                
                console.log('Adding to Firestore:', buildData);
                const docRef = await addDoc(buildsCollection, buildData);
                console.log('Build added to Firestore:', docRef.id);
                
                // Refresh builds
                await loadBuildsFromFirestore();
                renderBuildMuseum();
                
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload Build';
                    uploadBtn.disabled = false;
                }
                
                alert('Build uploaded successfully! üéâ');
                return true; // Success
                
            } catch (error) {
                console.error('Upload error:', error);
                console.error('Error details:', error.message, error.code);
                alert(`Failed to upload build: ${error.message}\n\nPlease try again or check console for details.`);
                
                const uploadBtn = document.getElementById('uploadSubmitBtn');
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload Build';
                    uploadBtn.disabled = false;
                }
                return false; // Failure
            }
        }
        
        // Show upload modal
        window.showUploadModal = function() {
            if (!BUILD_MUSEUM_ENABLED) {
                alert('Build Museum disabled');
                return;
            }
            if (!currentUser) {
                alert('Please sign in to upload builds!');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'build-modal show';
            modal.innerHTML = `
                <div class="build-modal-content" style="max-width: 500px;">
                    <button class="build-modal-close" onclick="this.closest('.build-modal').remove()">√ó</button>
                    <h2 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-upload"></i> Share Your Build
                    </h2>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 700; color: var(--text-bright);">Title</label>
                            <input id="buildTitle" type="text" placeholder="My Amazing Build" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(0,0,0,0.3); color: var(--text); font-size: 0.9rem;" maxlength="60">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 700; color: var(--text-bright);">Description</label>
                            <textarea id="buildDescription" placeholder="Tell us about your build..." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(0,0,0,0.3); color: var(--text); font-size: 0.9rem; min-height: 80px; resize: vertical;" maxlength="500"></textarea>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 700; color: var(--text-bright);">Media File</label>
                            <input id="buildFile" type="file" accept="image/*,video/*" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(0,0,0,0.3); color: var(--text); font-size: 0.9rem;">
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Max: 5MB for images, 50MB for videos (30s)</p>
                        </div>
                        <button onclick="handleBuildUpload()" style="background: linear-gradient(135deg, #FF1744, #FF5252); border: none; color: white; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 0.95rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 23, 68, 0.4);">
                            <i class="fas fa-cloud-upload-alt"></i> Upload Build
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        window.handleBuildUpload = async function() {
            if (!BUILD_MUSEUM_ENABLED) {
                alert('Build uploads are disabled for now.');
                return;
            }
            const title = document.getElementById('buildTitle').value.trim();
            const description = document.getElementById('buildDescription').value.trim();
            const fileInput = document.getElementById('buildFile');
            const file = fileInput?.files[0];
            
            if (!title) {
                alert('Please enter a title for your build.');
                return;
            }
            
            if (!file) {
                alert('Please select an image or video file.');
                return;
            }
            
            // Upload (modal will close on success)
            const success = await uploadBuild(file, title, description);
            
            // Close modal only on success
            if (success) {
                const modal = document.querySelector('.build-modal');
                if (modal) modal.remove();
            }
        }
        
        // Initialize Build Museum on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Build Museum only when explicitly enabled
            if (typeof BUILD_MUSEUM_ENABLED !== 'undefined' && BUILD_MUSEUM_ENABLED) {
                initBuildMuseum();
            } else {
                // hide build museum section & upload button
                const buildSection = document.getElementById('buildMuseumGrid')?.closest('section');
                if (buildSection) buildSection.style.display = 'none';
                const uploadBtn = document.getElementById('uploadBuildBtn');
                if (uploadBtn) uploadBtn.style.display = 'none';
            }
        });
        
        function renderInsights(insights) {
            const list = getElement('insightsList');
            if (!list) return;
            const items = insights || placeholderData.insights;
            
            const getStatus = (item) => {
                if (item.status) return item.status;
                const score = (item.score || '').toLowerCase();
                if (score.includes('healthy') || score.includes('on track') || score.includes('stable') || score.includes('good')) return 'good';
                if (score.includes('monitor') || score.includes('attention') || score.includes('warning')) return 'warning';
                if (score.includes('critical') || score.includes('alert')) return 'critical';
                return 'good';
            };
            
            const insightsHTML = items.map((item, i) => `
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-title">
                            <i class="fas fa-info-circle"></i>
                            ${item.title}
                        </div>
                        <span class="insight-badge ${getStatus(item)}">${item.score}</span>
                    </div>
                    <div class="insight-detail">${item.detail}</div>
                </div>
            `).join('');
            
            list.innerHTML = insightsHTML;
        }
        
        async function updateDashboard() {
            const statusText = getElement('statusText');
            const statusBadge = getElement('statusBadge');
            const statusDot = getElement('statusDot');
            const latencyDisplay = getElement('latencyDisplay');
            const startTime = performance.now();
            
            try {
                if (statusText) statusText.textContent = '‚ü≥';
                
                const data = await fetchMetrics();
                const totalTime = Math.round(performance.now() - startTime);
                
                // Update latency display
                if (latencyDisplay) {
                    latencyDisplay.textContent = `${totalTime}ms`;
                    latencyDisplay.style.color = totalTime < 100 ? 'var(--success)' : 
                                                 totalTime < 500 ? 'var(--warning)' : 'var(--danger)';
                }
                
                // Batch DOM updates using requestAnimationFrame
                requestAnimationFrame(() => {
                    // Render in order of visual priority
                    renderStats(data);
                    renderBuilders(data.topBuilders);
                    renderActivityFeed(data.activityLog);
                    renderNews(data.news);
                    // Build Museum is initialized on page load, not from API data
                });
                
                if (statusText) statusText.textContent = 'LIVE';
                if (statusBadge) {
                    statusBadge.style.background = 'rgba(16, 185, 129, 0.1)';
                    statusBadge.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                }
                if (statusDot) statusDot.style.background = 'var(--success)';
                
            } catch (error) {
                console.error('Dashboard update failed:', error);
                
                if (statusText) statusText.textContent = isOnline ? 'RETRY' : 'OFFLINE';
                if (statusBadge) {
                    statusBadge.style.background = 'rgba(239, 68, 68, 0.1)';
                    statusBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                }
                if (statusDot) statusDot.style.background = 'var(--danger)';
                if (latencyDisplay) latencyDisplay.textContent = '‚Äî';
            }
        }
        
        // Initialize when DOM is ready
        function initializeDashboard() {
            debug.log('üöÄ Initializing dashboard');
            loadActivityCache();
            lastActivityCount = activityCache.length;
            cleanOldActivities();
            
            // Preload initial data immediately
            updateDashboard().then(() => {
                debug.log('‚úì Initial data loaded');
            }).catch(err => {
                debug.error('‚úó Initial load failed:', err);
            });
            
            // News toggle functionality with smooth transition
            const toggleNewsBtn = getElement('toggleNews');
            const newsListWrapper = getElement('newsListWrapper');
            const newsChevron = getElement('newsChevron');
            const newsButtonText = getElement('newsButtonText');
            
            if (toggleNewsBtn && newsListWrapper && newsChevron && newsButtonText) {
                let isExpanded = false;
                
                // Load saved state from localStorage
                const savedState = localStorage.getItem('newsExpanded') === 'true';
                if (savedState) {
                    isExpanded = true;
                    newsListWrapper.style.maxHeight = '2000px';
                    newsListWrapper.style.opacity = '1';
                    newsListWrapper.style.marginTop = '16px';
                    newsChevron.className = 'fas fa-chevron-up';
                    newsButtonText.textContent = 'HIDE NEWS';
                    toggleNewsBtn.style.background = 'rgba(0, 230, 118, 0.15)';
                    toggleNewsBtn.style.borderColor = 'rgba(0, 230, 118, 0.4)';
                    toggleNewsBtn.style.color = 'var(--success)';
                }
                
                toggleNewsBtn.addEventListener('click', () => {
                    isExpanded = !isExpanded;
                    
                    if (isExpanded) {
                        newsListWrapper.style.maxHeight = '2000px';
                        newsListWrapper.style.opacity = '1';
                        newsListWrapper.style.marginTop = '16px';
                        newsChevron.className = 'fas fa-chevron-up';
                        newsButtonText.textContent = 'HIDE NEWS';
                        toggleNewsBtn.style.background = 'rgba(0, 230, 118, 0.15)';
                        toggleNewsBtn.style.borderColor = 'rgba(0, 230, 118, 0.4)';
                        toggleNewsBtn.style.color = 'var(--success)';
                        toggleNewsBtn.style.transform = 'scale(1.05)';
                        setTimeout(() => toggleNewsBtn.style.transform = 'scale(1)', 200);
                        localStorage.setItem('newsExpanded', 'true');
                    } else {
                        newsListWrapper.style.maxHeight = '0';
                        newsListWrapper.style.opacity = '0';
                        newsListWrapper.style.marginTop = '0';
                        newsChevron.className = 'fas fa-chevron-down';
                        newsButtonText.textContent = 'SHOW NEWS';
                        toggleNewsBtn.style.background = 'rgba(255, 23, 68, 0.15)';
                        toggleNewsBtn.style.borderColor = 'rgba(255, 23, 68, 0.4)';
                        toggleNewsBtn.style.color = 'var(--primary)';
                        toggleNewsBtn.style.transform = 'scale(0.95)';
                        setTimeout(() => toggleNewsBtn.style.transform = 'scale(1)', 200);
                        localStorage.setItem('newsExpanded', 'false');
                    }
                });
            }
            
            // Premium Ad Carousel Rotation
            let currentPremiumAdIndex = 0;
            const premiumAdSlides = document.querySelectorAll('.premium-ad-slide');
            const premiumAdDots = document.querySelectorAll('.premium-ad-dot');
            
            function rotatePremiumAd() {
                if (premiumAdSlides.length === 0) return;
                
                // Hide current with smooth fade
                premiumAdSlides[currentPremiumAdIndex].style.opacity = '0';
                premiumAdSlides[currentPremiumAdIndex].style.transform = 'translate3d(-50px, 0, 0) scale(0.95)';
                premiumAdSlides[currentPremiumAdIndex].classList.remove('active');
                premiumAdDots[currentPremiumAdIndex].style.background = 'rgba(255,255,255,0.4)';
                premiumAdDots[currentPremiumAdIndex].style.boxShadow = 'none';
                premiumAdDots[currentPremiumAdIndex].style.width = '10px';
                premiumAdDots[currentPremiumAdIndex].classList.remove('active');
                
                // Next index
                currentPremiumAdIndex = (currentPremiumAdIndex + 1) % premiumAdSlides.length;
                
                // Show next with smooth entrance using RAF for no jank
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        premiumAdSlides[currentPremiumAdIndex].style.transform = 'translate3d(0, 0, 0) scale(1)';
                        premiumAdSlides[currentPremiumAdIndex].style.opacity = '1';
                        premiumAdSlides[currentPremiumAdIndex].classList.add('active');
                        premiumAdDots[currentPremiumAdIndex].style.background = 'var(--primary)';
                        premiumAdDots[currentPremiumAdIndex].style.boxShadow = '0 0 16px var(--primary-glow), 0 0 0 3px rgba(255,23,68,0.3)';
                        premiumAdDots[currentPremiumAdIndex].style.width = '16px';
                        premiumAdDots[currentPremiumAdIndex].classList.add('active');
                    });
                });
                
                // Reset non-active slides
                premiumAdSlides.forEach((slide, idx) => {
                    if (idx !== currentPremiumAdIndex && !slide.classList.contains('active')) {
                        slide.style.transform = 'translate3d(50px, 0, 0) scale(0.95)';
                    }
                });
            }
            
            // Auto-rotate every 5 seconds
            setInterval(rotatePremiumAd, 5000);
            
            // Manual dot click
            premiumAdDots.forEach((dot, idx) => {
                dot.addEventListener('click', () => {
                    if (idx === currentPremiumAdIndex) return;
                    
                    const direction = idx > currentPremiumAdIndex ? -50 : 50;
                    
                    premiumAdSlides[currentPremiumAdIndex].style.opacity = '0';
                    premiumAdSlides[currentPremiumAdIndex].style.transform = `translate3d(${direction}px, 0, 0) scale(0.95)`;
                    premiumAdSlides[currentPremiumAdIndex].classList.remove('active');
                    premiumAdDots[currentPremiumAdIndex].style.background = 'rgba(255,255,255,0.4)';
                    premiumAdDots[currentPremiumAdIndex].style.boxShadow = 'none';
                    premiumAdDots[currentPremiumAdIndex].style.width = '10px';
                    premiumAdDots[currentPremiumAdIndex].classList.remove('active');
                    
                    currentPremiumAdIndex = idx;
                    
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            premiumAdSlides[currentPremiumAdIndex].style.transform = 'translate3d(0, 0, 0) scale(1)';
                            premiumAdSlides[currentPremiumAdIndex].style.opacity = '1';
                            premiumAdSlides[currentPremiumAdIndex].classList.add('active');
                            premiumAdDots[currentPremiumAdIndex].style.background = 'var(--primary)';
                            premiumAdDots[currentPremiumAdIndex].style.boxShadow = '0 0 16px var(--primary-glow), 0 0 0 3px rgba(255,23,68,0.3)';
                            premiumAdDots[currentPremiumAdIndex].style.width = '16px';
                            premiumAdDots[currentPremiumAdIndex].classList.add('active');
                        });
                    });
                });
            });
            
            // Optimized refresh - every 2 seconds for balance of speed and performance
            let refreshInterval = setInterval(updateDashboard, REFRESH_INTERVAL);
        
            // Clean old activity data every 6 hours to reduce overhead
            setInterval(() => {
                debug.log('Running cache cleanup');
                cleanOldActivities();
            }, 21600000);
            
            // Pause updates when page is hidden, resume immediately when visible
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Stop polling when hidden
                    clearInterval(refreshInterval);
                    debug.log('‚è∏ Paused updates');
                } else {
                    // Resume polling when visible
                    debug.log('‚ñ∂ Resumed updates');
                    cleanOldActivities();
                    updateDashboard(); // Immediate update
                    refreshInterval = setInterval(updateDashboard, REFRESH_INTERVAL);
                }
            });
        }
        
        // Wait for DOM to be ready before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            // DOM already loaded
            initializeDashboard();
        }
        
        // Network status monitoring
        window.addEventListener('online', () => {
            debug.log('üåê Network online');
            isOnline = true;
            consecutiveFailures = 0;
            updateDashboard();
        });
        
        window.addEventListener('offline', () => {
            debug.log('üì° Network offline');
            isOnline = false;
        });
        
        // Unlock audio on first user interaction (required for browser autoplay policies)
        document.addEventListener('click', unlockAudio, { once: true });
        document.addEventListener('keydown', unlockAudio, { once: true });
        document.addEventListener('touchstart', unlockAudio, { once: true });
        
        // Preload and cache critical resources
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                // Preconnect to API endpoint
                const link = document.createElement('link');
                link.rel = 'preconnect';
                link.href = new URL(REMOTE_METRICS_ENDPOINT).origin;
                document.head.appendChild(link);
            });
        }
    </script>
</body>
</html>
